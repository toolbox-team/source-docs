<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/oldreddit.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-BackgroundPage.html">BackgroundPage</a><ul class='methods'><li data-type='method'><a href="module-BackgroundPage.html#~handleMessage">handleMessage</a></li></ul></li><li><a href="module-CommentNuke.html">CommentNuke</a><ul class='methods'><li data-type='method'><a href="module-CommentNuke.html#~parseComments">parseComments</a></li></ul></li><li><a href="module-ProfilePro.html">ProfilePro</a><ul class='methods'><li data-type='method'><a href="module-ProfilePro.html#~addModSubsToSidebar">addModSubsToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~addToSiteTable">addToSiteTable</a></li><li data-type='method'><a href="module-ProfilePro.html#~addTrophiesToSidebar">addTrophiesToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~filterModdable">filterModdable</a></li><li data-type='method'><a href="module-ProfilePro.html#~hideModActionsThings">hideModActionsThings</a></li><li data-type='method'><a href="module-ProfilePro.html#~makeUserSidebar">makeUserSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~regExpEscape">regExpEscape</a></li><li data-type='method'><a href="module-ProfilePro.html#~searchProfile">searchProfile</a></li></ul></li><li><a href="module-queueOverlay.html">queueOverlay</a><ul class='methods'><li data-type='method'><a href="module-queueOverlay.html#~figureOutMulti">figureOutMulti</a></li><li data-type='method'><a href="module-queueOverlay.html#~makeQueueOverlay">makeQueueOverlay</a></li><li data-type='method'><a href="module-queueOverlay.html#~reloadIframe">reloadIframe</a></li></ul></li><li><a href="module-QueueTools.html">QueueTools</a><ul class='methods'><li data-type='method'><a href="module-QueueTools.html#~checkForActions">checkForActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getActions">getActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getModlog">getModlog</a></li></ul></li><li><a href="module-TBLog.html">TBLog</a></li></ul><h3>Namespaces</h3><ul><li><a href="TBApi.html">TBApi</a><ul class='methods'><li data-type='method'><a href="TBApi.html#.aboutUser">aboutUser</a></li><li data-type='method'><a href="TBApi.html#.apiOauthGET">apiOauthGET</a></li><li data-type='method'><a href="TBApi.html#.apiOauthPOST">apiOauthPOST</a></li><li data-type='method'><a href="TBApi.html#.approveThing">approveThing</a></li><li data-type='method'><a href="TBApi.html#.distinguishThing">distinguishThing</a></li><li data-type='method'><a href="TBApi.html#.flairPost">flairPost</a></li><li data-type='method'><a href="TBApi.html#.flairUser">flairUser</a></li><li data-type='method'><a href="TBApi.html#.friendUser">friendUser</a></li><li data-type='method'><a href="TBApi.html#.getBanState">getBanState</a></li><li data-type='method'><a href="TBApi.html#.getJSON">getJSON</a></li><li data-type='method'><a href="TBApi.html#.getLastActive">getLastActive</a></li><li data-type='method'><a href="TBApi.html#.getRatelimit">getRatelimit</a></li><li data-type='method'><a href="TBApi.html#.getReportReasons">getReportReasons</a></li><li data-type='method'><a href="TBApi.html#.getRules">getRules</a></li><li data-type='method'><a href="TBApi.html#.lock">lock</a></li><li data-type='method'><a href="TBApi.html#.markMessageRead">markMessageRead</a></li><li data-type='method'><a href="TBApi.html#.markOver18">markOver18</a></li><li data-type='method'><a href="TBApi.html#.post">post</a></li><li data-type='method'><a href="TBApi.html#.postComment">postComment</a></li><li data-type='method'><a href="TBApi.html#.postLink">postLink</a></li><li data-type='method'><a href="TBApi.html#.postToWiki">postToWiki</a></li><li data-type='method'><a href="TBApi.html#.readFromWiki">readFromWiki</a></li><li data-type='method'><a href="TBApi.html#.removeThing">removeThing</a></li><li data-type='method'><a href="TBApi.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="TBApi.html#.sendRequest">sendRequest</a></li><li data-type='method'><a href="TBApi.html#.stickyThread">stickyThread</a></li><li data-type='method'><a href="TBApi.html#.unfriendUser">unfriendUser</a></li><li data-type='method'><a href="TBApi.html#.unlock">unlock</a></li><li data-type='method'><a href="TBApi.html#.unMarkOver18">unMarkOver18</a></li><li data-type='method'><a href="TBApi.html#.unstickyThread">unstickyThread</a></li></ul></li><li><a href="TBCore.html">TBCore</a><ul class='members'><li data-type='member'><a href="TBCore.html#.baseDomain">baseDomain</a></li></ul><ul class='methods'><li data-type='method'><a href="TBCore.html#.alert">alert</a></li><li data-type='method'><a href="TBCore.html#.debugInformation">debugInformation</a></li><li data-type='method'><a href="TBCore.html#.getToolboxDevs">getToolboxDevs</a></li><li data-type='method'><a href="TBCore.html#.isConfigValidVersion">isConfigValidVersion</a></li><li data-type='method'><a href="TBCore.html#.link">link</a></li><li data-type='method'><a href="TBCore.html#.notification">notification</a></li><li data-type='method'><a href="TBCore.html#.updateCache">updateCache</a></li></ul></li><li><a href="TBHelpers.html">TBHelpers</a><ul class='methods'><li data-type='method'><a href="TBHelpers.html#.cleanSubredditName">cleanSubredditName</a></li><li data-type='method'><a href="TBHelpers.html#.colorNameToHex">colorNameToHex</a></li><li data-type='method'><a href="TBHelpers.html#.daysToMilliseconds">daysToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.debounce">debounce</a></li><li data-type='method'><a href="TBHelpers.html#.escapeHTML">escapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.getHashParameter">getHashParameter</a></li><li data-type='method'><a href="TBHelpers.html#.getRandomNumber">getRandomNumber</a></li><li data-type='method'><a href="TBHelpers.html#.getTime">getTime</a></li><li data-type='method'><a href="TBHelpers.html#.htmlDecode">htmlDecode</a></li><li data-type='method'><a href="TBHelpers.html#.htmlEncode">htmlEncode</a></li><li data-type='method'><a href="TBHelpers.html#.humaniseDays">humaniseDays</a></li><li data-type='method'><a href="TBHelpers.html#.literalRegExp">literalRegExp</a></li><li data-type='method'><a href="TBHelpers.html#.millisecondsToDays">millisecondsToDays</a></li><li data-type='method'><a href="TBHelpers.html#.minutesToMilliseconds">minutesToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.moveArrayItem">moveArrayItem</a></li><li data-type='method'><a href="TBHelpers.html#.niceDateDiff">niceDateDiff</a></li><li data-type='method'><a href="TBHelpers.html#.removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li data-type='method'><a href="TBHelpers.html#.removeQuotes">removeQuotes</a></li><li data-type='method'><a href="TBHelpers.html#.replaceAll">replaceAll</a></li><li data-type='method'><a href="TBHelpers.html#.replaceTokens">replaceTokens</a></li><li data-type='method'><a href="TBHelpers.html#.saneSort">saneSort</a></li><li data-type='method'><a href="TBHelpers.html#.saneSortAs">saneSortAs</a></li><li data-type='method'><a href="TBHelpers.html#.sortBy">sortBy</a></li><li data-type='method'><a href="TBHelpers.html#.stringToColor">stringToColor</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterISO">timeConverterISO</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterRead">timeConverterRead</a></li><li data-type='method'><a href="TBHelpers.html#.title_to_url">title_to_url</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeHTML">unescapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeJSON">unescapeJSON</a></li><li data-type='method'><a href="TBHelpers.html#.zlibDeflate">zlibDeflate</a></li><li data-type='method'><a href="TBHelpers.html#.zlibInflate">zlibInflate</a></li></ul></li><li><a href="TBui.html">TBui</a><ul class='members'><li data-type='member'><a href="TBui.html#.icons">icons</a></li></ul><ul class='methods'><li data-type='method'><a href="TBui.html#.clearNotification">clearNotification</a></li><li data-type='method'><a href="TBui.html#.contextTrigger">contextTrigger</a></li><li data-type='method'><a href="TBui.html#.makeCommentThread">makeCommentThread</a></li><li data-type='method'><a href="TBui.html#.makeSingleComment">makeSingleComment</a></li><li data-type='method'><a href="TBui.html#.makeSubmissionEntry">makeSubmissionEntry</a></li><li data-type='method'><a href="TBui.html#.popup">popup</a></li><li data-type='method'><a href="TBui.html#.showNotification">showNotification</a></li><li data-type='method'><a href="TBui.html#.tbRedditEvent">tbRedditEvent</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/oldreddit.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

function oldReddit () {
    const self = new TB.Module('Old reddit');
    self.shortname = 'oldreddit';

    // Default settings
    self.settings['enabled']['default'] = true;

    self.config['betamode'] = false;

    // How about you don't disable the general settings module?  No other module should ever do this. Well except for the support module and the old reddit module..
    // So yeah it depends... But seriously normal modules should not do this.
    self.settings['enabled']['hidden'] = true; // Don't disable it, either!

    TB.register_module(self);

    function dispatchApiEvent (element, object) {
        const apiEvent = new CustomEvent('tbReddit', {detail: object});
        try {
            element.dispatchEvent(apiEvent);
        } catch (error) {
            self.log('Could not dispatch event', object);
        }
    }

    /**
     * Handles `thing` items as they become visible in the viewport.
     * @function
     * @param {IntersectionObserverEntry[]} entries
     * @param {IntersectionObserver} observer
     */
    function handleThing (entries, observer) {
        entries.forEach(entry => {
            // The observer fires for everything on page load.
            // This makes sure that we really only act on those items that are visible.
            if (!entry.isIntersecting) {
                return;
            }

            // Element is visible, we only want to handle it once. Stop observing.
            observer.unobserve(entry.target);
            const $thing = $(entry.target);
            const info = TBCore.getThingInfo($thing);

            requestAnimationFrame(() => {
                const $jsApiThingPlaceholder = $('&lt;div class="tb-jsapi-container">&lt;/div>').appendTo($thing.find('.entry:first'));
                $jsApiThingPlaceholder.append('&lt;span data-name="toolbox">');
                const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];
                $thing.find('.entry:first .author:first').after('&lt;span class="tb-jsapi-author-container">&lt;/span>');
                const $jsApiPlaceholderAuthor = $thing.find('.tb-jsapi-author-container');
                $jsApiPlaceholderAuthor.append('&lt;span data-name="toolbox">');
                const jsApiPlaceholderAuthor = $jsApiPlaceholderAuthor[0];

                if (!$jsApiThingPlaceholder.length || !$jsApiPlaceholderAuthor.length) {
                    return;
                }

                if (info.kind === 'submission') {
                    if (!$jsApiThingPlaceholder.hasClass('tb-frontend-container')) {
                        const detailObject = {
                            type: 'TBpost',
                            data: {
                                author: info.author,
                                id: info.id,
                                isRemoved: info.ham || info.spam,
                                permalink: `https://www.reddit.com/${info.postlink.replace(/https?:\/\/...?\.reddit\.com\/?/, '').replace(/^\//, '')}`,
                                subreddit: {
                                    name: info.subreddit,
                                    type: info.subredditType,
                                },
                            },
                        };

                        dispatchApiEvent(jsApiThingPlaceholder, detailObject);
                    }
                    // We don't want to send events for things already handled.
                    if (!$jsApiPlaceholderAuthor.hasClass('tb-frontend-container')) {
                        const detailObject = {
                            type: 'TBpostAuthor',
                            data: {
                                author: info.author,
                                post: {
                                    id: info.id,
                                },
                                subreddit: {
                                    name: info.subreddit,
                                    type: info.subredditType,
                                },
                            },
                        };

                        dispatchApiEvent(jsApiPlaceholderAuthor, detailObject);
                    }
                }

                if (info.kind === 'comment') {
                    // Comment
                    if (!$jsApiThingPlaceholder.hasClass('tb-frontend-container')) {
                        const detailObject = {
                            type: 'TBcommentOldReddit',
                            data: {
                                author: info.author,
                                post: {
                                    id: info.postID,
                                },
                                isRemoved: info.ham || info.spam,
                                id: info.id,
                                subreddit: {
                                    name: info.subreddit,
                                    type: info.subredditType,
                                },
                            },
                        };

                        dispatchApiEvent(jsApiThingPlaceholder, detailObject);
                    }
                    // Author
                    // We don't want to send events for things already handled.
                    if (!$jsApiPlaceholderAuthor.hasClass('tb-frontend-container')) {
                        const detailObject = {
                            type: 'TBcommentAuthor',
                            data: {
                                author: info.author,
                                post: {
                                    id: info.postID,
                                },
                                comment: {
                                    id: info.id,
                                },
                                subreddit: {
                                    name: info.subreddit,
                                    type: info.subredditType,
                                },
                            },
                        };
                        dispatchApiEvent(jsApiPlaceholderAuthor, detailObject);
                    }
                }
            });
        });
    }

    const viewportObserver = new IntersectionObserver(handleThing, {
        rootMargin: '200px',
    });

    function thingCrawler () {
        const $things = $('div.content .thing:not(.tb-seen) .entry').closest('.thing');
        $things.each(function () {
            requestAnimationFrame(() => {
                $(this).addClass('tb-seen');
                viewportObserver.observe(this);
            });
        });
    }

    function newModmailConversationAuthors () {
        const $body = $('body');
        const subreddit = $body.find('.ThreadTitle__community').text();
        $body.find('.Thread__message:not(.tb-seen)').each(function () {
            const $this = $(this);
            $this.addClass('tb-seen');
            const $jsApiThingPlaceholder = $(`
                &lt;span class="tb-jsapi-container">
                    &lt;span data-name="toolbox">&lt;/span>
                &lt;/span>
            `).insertAfter($this.find('.Message__divider').eq(0));
            const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];

            const author = $this.find('.Message__header .Message__author').text().substring(2);
            const idDetails = $this.find('.m-link').attr('href').match(/\/mail\/.*?\/(.*?)\/(.*?)$/i);

            const detailObject = {
                type: 'TBmodmailCommentAuthor',
                data: {
                    author,
                    post: {
                        id: idDetails[1],
                    },
                    comment: {
                        id: idDetails[2],
                    },
                    subreddit: {
                        name: subreddit,
                    },
                },
            };

            dispatchApiEvent(jsApiThingPlaceholder, detailObject);
        });
    }

    /**
     * Makes sure to fire a jsAPI `TBuserHovercard` event for new modmail sidebar instances.
     * @function
     */
    function newModmailSidebar () {
        setTimeout(() => {
            const $body = $('body');
            if ($body.find('.ThreadViewer').length) {
                $body.find('.ThreadViewer__infobar:not(.tb-seen), .ThreadViewerHeader__infobar:not(.tb-seen)').each(function () {
                    const $infobar = $(this);
                    $infobar.addClass('tb-seen');
                    const info = TBCore.getThingInfo(this, true);
                    const $jsApiThingPlaceholder = $(`
                        &lt;div class="tb-jsapi-container InfoBar__recents">
                            &lt;div class="InfoBar__recentsTitle">Toolbox functions:&lt;/div>
                            &lt;span data-name="toolbox">&lt;/span>
                        &lt;/div>
                    `).appendTo($infobar);

                    const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];

                    const detailObject = {
                        type: 'TBuserHovercard',
                        data: {
                            user: {
                                username: info.user,
                            },
                            contextID: info.id,
                            subreddit: {
                                name: info.subreddit,
                            },
                        },
                    };

                    dispatchApiEvent(jsApiThingPlaceholder, detailObject);
                });
            }
        }, 500);
    }

    self.init = function () {
        // Looks like we are on old reddit. Activate!
        if (TBCore.isOldReddit) {
            setTimeout(() => {
                thingCrawler();

                window.addEventListener('TBNewThings', () => {
                    thingCrawler();
                });
            }, 500);
        }

        if (TBCore.isNewModmail) {
            const $body = $('body');

            $body.on('click', '.icon-user', () => {
                setTimeout(() => {
                    newModmailSidebar();
                }, 500);
            });

            $body.on('click', '.Thread__grouped', () => {
                setTimeout(() => {
                    newModmailConversationAuthors();
                }, 500);
            });

            window.addEventListener('TBNewPage', event => {
                if (event.detail.pageType === 'modmailConversation') {
                    setTimeout(() => {
                        newModmailSidebar();
                        newModmailConversationAuthors();
                    }, 500);
                }
            });
        }
    };
}

window.addEventListener('TBModuleLoaded', () => {
    oldReddit();
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Oct 02 2020 07:29:11 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
