<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/modnotes.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#get">get</a></li><li data-type='method'><a href="Module.html#getEnabled">getEnabled</a></li><li data-type='method'><a href="Module.html#init">init</a></li><li data-type='method'><a href="Module.html#set">set</a></li><li data-type='method'><a href="Module.html#setEnabled">setEnabled</a></li></ul></li><li><a href="Ratelimiter.html">Ratelimiter</a><ul class='methods'><li data-type='method'><a href="Ratelimiter.html#_sendRequest">_sendRequest</a></li><li data-type='method'><a href="Ratelimiter.html#emitInfo">emitInfo</a></li><li data-type='method'><a href="Ratelimiter.html#request">request</a></li></ul></li><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-BackgroundPage.html">BackgroundPage</a><ul class='methods'><li data-type='method'><a href="module-BackgroundPage.html#~handleMessage">handleMessage</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#aboutUser">aboutUser</a></li><li><a href="global.html#actionButton">actionButton</a></li><li><a href="global.html#addModSubsToSidebar">addModSubsToSidebar</a></li><li><a href="global.html#addToSiteTable">addToSiteTable</a></li><li><a href="global.html#addTrophiesToSidebar">addTrophiesToSidebar</a></li><li><a href="global.html#alert">alert</a></li><li><a href="global.html#apiOauthDELETE">apiOauthDELETE</a></li><li><a href="global.html#apiOauthGET">apiOauthGET</a></li><li><a href="global.html#apiOauthPOST">apiOauthPOST</a></li><li><a href="global.html#approveThing">approveThing</a></li><li><a href="global.html#baseDomain">baseDomain</a></li><li><a href="global.html#betaRelease">betaRelease</a></li><li><a href="global.html#browserName">browserName</a></li><li><a href="global.html#button">button</a></li><li><a href="global.html#checkForActions">checkForActions</a></li><li><a href="global.html#checkLoadConditions">checkLoadConditions</a></li><li><a href="global.html#checkReset">checkReset</a></li><li><a href="global.html#cleanSubredditName">cleanSubredditName</a></li><li><a href="global.html#clearCache">clearCache</a></li><li><a href="global.html#clearNotification">clearNotification</a></li><li><a href="global.html#colorNameToHex">colorNameToHex</a></li><li><a href="global.html#contextTrigger">contextTrigger</a></li><li><a href="global.html#coreLoadedPromise">coreLoadedPromise</a></li><li><a href="global.html#createModNote">createModNote</a></li><li><a href="global.html#createModNotesBadge">createModNotesBadge</a></li><li><a href="global.html#createModNotesPopup">createModNotesPopup</a></li><li><a href="global.html#daysToMilliseconds">daysToMilliseconds</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#debugInformation">debugInformation</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#deleteModNote">deleteModNote</a></li><li><a href="global.html#displayNotes">displayNotes</a></li><li><a href="global.html#distinguishThing">distinguishThing</a></li><li><a href="global.html#domain">domain</a></li><li><a href="global.html#escapeHTML">escapeHTML</a></li><li><a href="global.html#fetchModSubs">fetchModSubs</a></li><li><a href="global.html#fetchNewsNotes">fetchNewsNotes</a></li><li><a href="global.html#figureOutMulti">figureOutMulti</a></li><li><a href="global.html#filterModdable">filterModdable</a></li><li><a href="global.html#flairPost">flairPost</a></li><li><a href="global.html#flairUser">flairUser</a></li><li><a href="global.html#friendUser">friendUser</a></li><li><a href="global.html#generateNoteTableRow">generateNoteTableRow</a></li><li><a href="global.html#getActions">getActions</a></li><li><a href="global.html#getAnonymizedSettings">getAnonymizedSettings</a></li><li><a href="global.html#getBanState">getBanState</a></li><li><a href="global.html#getCache">getCache</a></li><li><a href="global.html#getCurrentUser">getCurrentUser</a></li><li><a href="global.html#getJSON">getJSON</a></li><li><a href="global.html#getLastActive">getLastActive</a></li><li><a href="global.html#getLastVersion">getLastVersion</a></li><li><a href="global.html#getLatestModNote">getLatestModNote</a></li><li><a href="global.html#getModhash">getModhash</a></li><li><a href="global.html#getModlog">getModlog</a></li><li><a href="global.html#getModNotes">getModNotes</a></li><li><a href="global.html#getModSubs">getModSubs</a></li><li><a href="global.html#getRandomNumber">getRandomNumber</a></li><li><a href="global.html#getRatelimit">getRatelimit</a></li><li><a href="global.html#getRecentModNotes">getRecentModNotes</a></li><li><a href="global.html#getReportReasons">getReportReasons</a></li><li><a href="global.html#getRules">getRules</a></li><li><a href="global.html#getSetting">getSetting</a></li><li><a href="global.html#getSettingAsync">getSettingAsync</a></li><li><a href="global.html#getSettings">getSettings</a></li><li><a href="global.html#getSubredditColors">getSubredditColors</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getToolboxDevs">getToolboxDevs</a></li><li><a href="global.html#getUserDetails">getUserDetails</a></li><li><a href="global.html#handleTBThings">handleTBThings</a></li><li><a href="global.html#handleThing">handleThing</a></li><li><a href="global.html#hideModActionsThings">hideModActionsThings</a></li><li><a href="global.html#htmlDecode">htmlDecode</a></li><li><a href="global.html#htmlEncode">htmlEncode</a></li><li><a href="global.html#humaniseDays">humaniseDays</a></li><li><a href="global.html#icons">icons</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initialLoadPromise">initialLoadPromise</a></li><li><a href="global.html#isConfigValidVersion">isConfigValidVersion</a></li><li><a href="global.html#isEquivalent">isEquivalent</a></li><li><a href="global.html#labelColors">labelColors</a></li><li><a href="global.html#labelNames">labelNames</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#listenerAliases">listenerAliases</a></li><li><a href="global.html#literalRegExp">literalRegExp</a></li><li><a href="global.html#lock">lock</a></li><li><a href="global.html#makeCommentThread">makeCommentThread</a></li><li><a href="global.html#makeQueueOverlay">makeQueueOverlay</a></li><li><a href="global.html#makeSingleComment">makeSingleComment</a></li><li><a href="global.html#makeSubmissionEntry">makeSubmissionEntry</a></li><li><a href="global.html#makeUserSidebar">makeUserSidebar</a></li><li><a href="global.html#markMessageRead">markMessageRead</a></li><li><a href="global.html#markOver18">markOver18</a></li><li><a href="global.html#millisecondsToDays">millisecondsToDays</a></li><li><a href="global.html#minutesToMilliseconds">minutesToMilliseconds</a></li><li><a href="global.html#moveArrayItem">moveArrayItem</a></li><li><a href="global.html#newModmailSidebar">newModmailSidebar</a></li><li><a href="global.html#niceDateDiff">niceDateDiff</a></li><li><a href="global.html#notification">notification</a></li><li><a href="global.html#overlay">overlay</a></li><li><a href="global.html#pager">pager</a></li><li><a href="global.html#pagerForItems">pagerForItems</a></li><li><a href="global.html#parseComments">parseComments</a></li><li><a href="global.html#parser">parser</a></li><li><a href="global.html#popup">popup</a></li><li><a href="global.html#post">post</a></li><li><a href="global.html#postComment">postComment</a></li><li><a href="global.html#postLink">postLink</a></li><li><a href="global.html#postToWiki">postToWiki</a></li><li><a href="global.html#purify">purify</a></li><li><a href="global.html#purifyObject">purifyObject</a></li><li><a href="global.html#RandomFeedback">RandomFeedback</a></li><li><a href="global.html#RandomQuote">RandomQuote</a></li><li><a href="global.html#readFromWiki">readFromWiki</a></li><li><a href="global.html#regExpEscape">regExpEscape</a></li><li><a href="global.html#reloadIframe">reloadIframe</a></li><li><a href="global.html#reloadToolbox">reloadToolbox</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li><a href="global.html#removeQuotes">removeQuotes</a></li><li><a href="global.html#removeThing">removeThing</a></li><li><a href="global.html#replaceAll">replaceAll</a></li><li><a href="global.html#replaceTokens">replaceTokens</a></li><li><a href="global.html#saneSort">saneSort</a></li><li><a href="global.html#saneSortAs">saneSortAs</a></li><li><a href="global.html#saveSettingsToBrowser">saveSettingsToBrowser</a></li><li><a href="global.html#searchProfile">searchProfile</a></li><li><a href="global.html#sendMessage">sendMessage</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setCache">setCache</a></li><li><a href="global.html#setSetting">setSetting</a></li><li><a href="global.html#setSettingAsync">setSettingAsync</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#settingsToObject">settingsToObject</a></li><li><a href="global.html#showNote">showNote</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#sortBy">sortBy</a></li><li><a href="global.html#standardColors">standardColors</a></li><li><a href="global.html#stickyThread">stickyThread</a></li><li><a href="global.html#stringToColor">stringToColor</a></li><li><a href="global.html#syntaxHighlighterThemeSelect">syntaxHighlighterThemeSelect</a></li><li><a href="global.html#TBLog">TBLog</a></li><li><a href="global.html#tbRedditEvent">tbRedditEvent</a></li><li><a href="global.html#TBsettingsObject">TBsettingsObject</a></li><li><a href="global.html#timeConverterRead">timeConverterRead</a></li><li><a href="global.html#title_to_url">title_to_url</a></li><li><a href="global.html#typeNames">typeNames</a></li><li><a href="global.html#unescapeHTML">unescapeHTML</a></li><li><a href="global.html#unescapeJSON">unescapeJSON</a></li><li><a href="global.html#unfriendUser">unfriendUser</a></li><li><a href="global.html#unlock">unlock</a></li><li><a href="global.html#unMarkOver18">unMarkOver18</a></li><li><a href="global.html#unstickyThread">unstickyThread</a></li><li><a href="global.html#updateModNotesBadge">updateModNotesBadge</a></li><li><a href="global.html#updateModNotesPopup">updateModNotesPopup</a></li><li><a href="global.html#userDetailsPromise">userDetailsPromise</a></li><li><a href="global.html#verifiedSettingsSave">verifiedSettingsSave</a></li><li><a href="global.html#watchForURLChanges">watchForURLChanges</a></li><li><a href="global.html#zlibDeflate">zlibDeflate</a></li><li><a href="global.html#zlibInflate">zlibInflate</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/modnotes.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {Module} from '../tbmodule.js';
import {getModSubs, link, modsSub} from '../tbcore.js';
import {escapeHTML, htmlEncode} from '../tbhelpers.js';
import * as TBApi from '../tbapi.js';
import {actionButton, drawPosition, icons, pagerForItems, popup} from '../tbui.js';
import TBListener from '../tblistener.js';

/**
 * An object mapping modnote types to human-friendly display names.
 * @constant {object}
 */
// NOTE: values of this object are not escaped before being inserted in HTML
const typeNames = {
    NOTE: 'Note',
    APPROVAL: 'Approve',
    REMOVAL: 'Remove',
    BAN: 'Ban',
    MUTE: 'Mail Mute',
    INVITE: 'Invite',
    SPAM: 'Spam',
    CONTENT_CHANGE: 'Update Post',
    MOD_ACTION: 'Mod Action',
};

/**
 * An object mapping modnote labels to display colors. All colors are from
 * the default Toolbox usernote type colors, except the HELPFUL_USER label
 * which doesn't have an analogue in Toolbox usernotes.
 * @constant {object}
 */
// NOTE: values of this object are not escaped before being inserted in HTML
const labelColors = {
    BOT_BAN: 'black',
    PERMA_BAN: 'darkred',
    BAN: 'red',
    ABUSE_WARNING: 'orange',
    SPAM_WARNING: 'purple',
    SPAM_WATCH: 'fuschia',
    SOLID_CONTRIBUTOR: 'green',
    HELPFUL_USER: 'lightseagreen',
};

/**
 * An object mapping modnote lavels to human-friendly display names.
 * @constant {object}
 */
// NOTE: values of this object are not escaped before being inserted in HTML
const labelNames = {
    BOT_BAN: 'Bot Ban',
    PERMA_BAN: 'Permaban',
    BAN: 'Ban',
    ABUSE_WARNING: 'Abuse Warning',
    SPAM_WARNING: 'Spam Warning',
    SPAM_WATCH: 'Spam Watch',
    SOLID_CONTRIBUTOR: 'Solid Contributor',
    HELPFUL_USER: 'Helpful User',
};

// A queue of users and subreddits whose latest note will be fetched in the next
// bulk call, alongside the associated resolve and reject functions so we can
// pass the individual results back to their callers; used by `getLatestModNote`
let pendingLatestNoteRequests = [];

// The ID of the timeout for performing the bulk API request; used by
// `getLatestModNote` to debounce the request
let fetchLatestNotesTimeout;

/**
 * Fetches the most recent mod note on the given user in the given subreddit.
 * @param {string} subreddit The name of the subreddit
 * @param {string} user The name of the user
 * @returns {Promise} Resolves to a note object or `null`, or rejects an error
 */
function getLatestModNote (subreddit, user) {
    return new Promise((resolve, reject) => {
        // Add this user/subreddit to the queue to be included in the next call,
        // alongside this promise's resolve and reject functions so we can pass
        // the result back to the caller
        pendingLatestNoteRequests.push({
            subreddit,
            user,
            resolve,
            reject,
        });

        // Each time this function is called, we set a timeout to process the
        // queue 500ms later. However, if the function is called again in that
        // time, that should be cancelled and rescheduled for 500ms after the
        // later call.

        // Cancel any existing timeout
        clearTimeout(fetchLatestNotesTimeout);
        fetchLatestNotesTimeout = null;

        // If we have 500 users/subs queued, that's the max the API can handle
        // at once, so process the queue now rather than waiting longer
        if (pendingLatestNoteRequests.length === 500) {
            processQueue();
            return;
        }

        // Otherwise, set a timeout to process the queue in 500ms
        fetchLatestNotesTimeout = setTimeout(processQueue, 500);
    });

    // This function executes the API request to fetch the latest note for all
    // the users/subreddits queued, and distributes results (or errors) to their
    // corresponding callers.
    async function processQueue () {
        // Store a copy of the queue as it is right now, then immediately clear
        // the queue, so additional requests can be queued for the next batch
        // while we handle the current batch
        const queuedRequests = pendingLatestNoteRequests;
        pendingLatestNoteRequests = [];

        try {
            // The API takes separate arrays of subs and users, so build those
            const subreddits = queuedRequests.map(entry => entry.subreddit);
            const users = queuedRequests.map(entry => entry.user);

            // Perform the request to fetch the notes
            const notes = await TBApi.getRecentModNotes(subreddits, users);

            // We now have to pass each note to the appropriate caller's promise
            // resolver; since the arrays are in the same order, we can loop
            // over all the resolve functions and call them, passing the note at
            // the corresponding index in the notes array
            for (const [i, {resolve}] of Object.entries(queuedRequests)) {
                resolve(notes[i]);
            }
        } catch (error) {
            // If there was an error, reject all the the promises
            for (const {reject} of queuedRequests) {
                reject(error);
            }
        }
    }
}

/**
 * Creates a mod note badge for the given information.
 * @param {object} data Data associated with the badge
 * @param {string} data.user Name of the relevant user
 * @param {string} data.subreddit Name of the relevant subreddit
 * @param {string} data.label Text shown in the badge if there are no notes
 * @param {object} [data.note] The most recent mod note left on the user
 * @returns {jQuery} The created badge
 */
function createModNotesBadge ({
    user,
    subreddit,
    label = 'NN',
    note,
}) {
    const $badge = $(`
        &lt;a
            class="tb-bracket-button tb-modnote-badge"
            role="button"
            tabindex="0"
            title="Mod notes for /u/${user} in /r/${subreddit}"
            data-user="${user}"
            data-subreddit="${subreddit}"
            data-label="${label}"
        >
    `);

    updateModNotesBadge($badge, {
        note,
    });

    return $badge;
}

/**
 * Updates mod note badges in place with the given information.
 * @param {jQuery} $badge The badge(s) to update
 * @param {object} note The most recent mod note left on the user, or null
 */
function updateModNotesBadge ($badge, note) {
    if (!note || !note.user_note_data) {
        $badge.text($badge.attr('data-label'));
        return;
    }

    $badge.empty();
    $badge.append(`
        &lt;b style="${note.user_note_data.label ? `color: ${labelColors[note.user_note_data.label]}` : ''}">
            ${htmlEncode(note.user_note_data.note)}
        &lt;/b>
    `);
}

/**
 * Creates a mod note popup for the given information.
 * @param {object} data Data associated with the popup
 * @param {string} data.user Name of the relevant user
 * @param {string} data.subreddit Name of the relevant subreddit
 * @param {object[]} [data.notes] Note objects for the user, or null/undefined
 * @returns {jQuery} The created popup
 */
function createModNotesPopup ({
    user,
    subreddit,
    notes,
}) {
    const $popup = popup({
        title: `Mod notes for /u/${user} in /r/${subreddit}`,
        tabs: [
            {
                title: 'All Activity',
                id: 'tb-modnote-tab-all',
            },
            {
                title: 'Notes',
                id: 'tb-modnote-tab-notes',
            },
            {
                id: 'tb-modnote-tab-actions',
                title: 'Mod Actions',
            },
        ],
        footer: $(`
            &lt;span>
                &lt;input type="text" class="tb-modnote-text-input tb-input">
            &lt;/span>
        `)
            .append(actionButton('Create Note', 'tb-modnote-create-button')),
        cssClass: 'tb-modnote-popup',
    });
    $popup.attr('data-user', user);
    $popup.attr('data-subreddit', subreddit);

    updateModNotesPopup($popup, {
        notes,
    });

    return $popup;
}

/**
 * Updates a mod notes popup in place with the given information.
 * @param {jQuery} $popup The popup to update
 * @param {object} data
 * @param {object[]} [data.notes] Note objects for the user, or null/undefined
 */
function updateModNotesPopup ($popup, {
    notes,
}) {
    // Build a table for each tab containing the right subset of notes
    $popup.find('.tb-window-tab').each(function () {
        const $tabContainer = $(this);

        const $content = $tabContainer.find('.tb-window-content');
        $content.empty();

        if (!notes) {
            // Notes being null/undefined indicates notes couldn't be fetched
            // TODO: probably pass errors into this function for display, and
            //       also to distinguish "failed to load" from "still loading"
            $content.append(`
                &lt;p class="error">
                    Error fetching mod notes
                &lt;/p>
            `);
            return;
        }

        // Filter notes as appropriate for this tab
        let filteredNotes = notes;
        if ($tabContainer.hasClass('tb-modnote-tab-notes')) {
            filteredNotes = notes.filter(note => note.user_note_data?.note);
        }
        if ($tabContainer.hasClass('tb-modnote-tab-actions')) {
            filteredNotes = notes.filter(note => note.mod_action_data?.action);
        }

        if (!filteredNotes.length) {
            // If the notes list is empty, our job is very easy
            $content.append(`
                &lt;p>
                    No notes
                &lt;/p>
            `);
        } else {
            // Generate a table for the notes we have and display that
            const $notesPager = pagerForItems({
                items: filteredNotes,
                perPage: 10,
                displayItem: generateNoteTableRow,
                wrapper: `
                    &lt;table class="tb-modnote-table">
                        &lt;thead>
                            &lt;tr>
                                &lt;th>Author&lt;/th>
                                &lt;th>Type&lt;/th>
                                &lt;th>Details&lt;/th>
                                &lt;th>&lt;/th>
                            &lt;/tr>
                        &lt;/thead>
                    &lt;/table>
                `,
            });
            $content.append($notesPager);
        }
    });
}

/**
 * Generates a table of the given notes.
 * @param {object[]} notes An array of note objects
 * @returns {jQuery} The generated table
 */
function generateNoteTableRow (note) {
    const createdAt = new Date(note.created_at * 1000);
    const mod = note.operator; // TODO: can [deleted] show up here?

    const $noteRow = $(`
        &lt;tr>
            &lt;td>
                &lt;a href="${link(`/user/${encodeURIComponent(mod)}`)}">
                    /u/${escapeHTML(mod)}
                &lt;/a>
                &lt;br>
                &lt;small>
                    &lt;time datetime="${escapeHTML(createdAt.toISOString())}">
                        ${escapeHTML(createdAt.toLocaleString())}
                    &lt;/time>
                &lt;/small>
            &lt;/td>
            &lt;td>
                ${typeNames[note.type]}
            &lt;/td>
        &lt;/tr>
    `);

    // Build the note details based on what sort of information is present
    const $noteDetails = $('&lt;td>');

    if (note.mod_action_data?.action) {
        $noteDetails.append(`
            &lt;span class="tb-modnote-action-summary">
                Took action "${escapeHTML(note.mod_action_data.action)}"${note.mod_action_data.details ? ` (${escapeHTML(note.mod_action_data.details)})` : ''}${note.mod_action_data.description ? `: ${escapeHTML(note.mod_action_data.description)}` : ''}
            &lt;/span>
        `);
    }

    if (note.user_note_data?.note) {
        $noteDetails.append(`
            &lt;blockquote>
                ${note.user_note_data.label ? `
                    &lt;span style="color:${labelColors[note.user_note_data.label]}">
                        [${labelNames[note.user_note_data.label] || escapeHTML(note.user_note_data.label)}]
                    &lt;/span>
                ` : ''}
                ${escapeHTML(note.user_note_data.note)}
            &lt;/blockquote>
        `);
    }

    $noteRow.append($noteDetails);

    // Only manually added notes can be deleted
    if (note.type === 'NOTE') {
        $noteRow.append(`
            &lt;td>
                &lt;a
                    href="#"
                    role="button"
                    class="tb-modnote-delete-button tb-icons tb-icons-negative"
                    data-note-id="${escapeHTML(note.id)}"
                >
                    ${icons.delete}
                &lt;/a>
            &lt;/td>
        `);
    } else {
        // append an empty td to avoid weird border stuff
        $noteRow.append('&lt;td>');
    }

    $noteRow.find('time').timeago();

    return $noteRow;
}

export default new Module({
    name: 'Mod Notes',
    id: 'ModNotes',
    beta: true,
    enabledByDefault: true,
}, function () {
    // Handle authors showing up on the page
    TBListener.on('author', async e => {
        const subreddit = e.detail.data.subreddit.name;
        const author = e.detail.data.author;

        // Deleted users can't have notes
        if (author === '[deleted]') {
            return;
        }

        // Can't fetch notes in a sub you're not a mod of
        // TODO: What specific permissions are required to fetch notes?
        await getModSubs();
        if (!await modsSub(subreddit)) {
            return;
        }

        // Return early if we don't have the things we need
        if (!e.detail.data.subreddit.name || !e.detail.data.author) {
            return;
        }

        // Display badge for notes if not already present
        const $target = $(e.target);
        let $badge = $target.find('.tb-modnote-badge');
        if (!$badge.length) {
            $badge = createModNotesBadge({
                user: e.detail.data.author,
                subreddit: e.detail.data.subreddit.name,
            });
            // TODO: don't register this directly on the badge, use $body.on('click', selector, ...)
            $badge.on('click', async clickEvent => {
                // TODO: open popup with more information for this user
                this.info(`clicked badge for /u/${author} in /r/${subreddit}`);

                // Fetch all usernotes for this user
                let notes;
                try {
                    // TODO: store these somewhere persistent so they can be
                    //       added to later if the user wants to load more
                    notes = await TBApi.getModNotes(subreddit, author);
                } catch (error) {
                    this.error(`Error fetching mod notes for /u/${author} in /r/${subreddit}`, error);
                }

                // Create, position, and display popup
                const positions = drawPosition(clickEvent);
                createModNotesPopup({
                    user: author,
                    subreddit,
                    notes,
                })
                    .css({
                        top: positions.topPosition,
                        left: positions.leftPosition,
                    })
                    .appendTo($('body'));
            });
            $badge.appendTo($target);
        }

        this.debug(`Fetching latest mod note for /u/${author} in /r/${subreddit}`);
        try {
            const note = await getLatestModNote(subreddit, author);
            this.info(`Got note for /u/${author} in /r/${subreddit}:`, note);
            updateModNotesBadge($badge, note);
        } catch (error) {
            this.error(`Error fetching mod notes for /u/${author} in /r/${subreddit}:`, error);
        }
    });

    const $body = $('body');

    // Handle create note button clicks
    $body.on('click', '.tb-modnote-create-button', async event => {
        const $popup = $(event.target).closest('.tb-modnote-popup');
        const $textInput = $popup.find('.tb-modnote-text-input');
        try {
            await TBApi.createModNote({
                user: $popup.attr('data-user'),
                subreddit: $popup.attr('data-subreddit'),
                note: $textInput.val(),
            });
            $textInput.val('');
            alert('Note saved!');
            // TODO: add the new note to the table maybe? does creating the note
            //       return the created note object? that would make it easy
        } catch (error) {
            this.error('Failed to create mod note:', error);
            alert('Failed to create mod note');
        }
    });

    // Handle delete note button clicks
    $body.on('click', '.tb-modnote-delete-button', async event => {
        const $button = $(event.target);
        const $popup = $button.closest('.tb-modnote-popup');

        try {
            await TBApi.deleteModNote({
                user: $popup.attr('data-user'),
                subreddit: $popup.attr('data-subreddit'),
                id: $button.attr('data-note-id'),
            });
            $button.closest('tr').remove();
            alert('Note removed!');
        } catch (error) {
            this.error('Failed to delete note:', error);
            alert('Failed to delete note');
        }
    });
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Sat Sep 03 2022 06:50:30 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
