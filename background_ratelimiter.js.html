<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>background/ratelimiter.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#get">get</a></li><li data-type='method'><a href="Module.html#getEnabled">getEnabled</a></li><li data-type='method'><a href="Module.html#init">init</a></li><li data-type='method'><a href="Module.html#set">set</a></li><li data-type='method'><a href="Module.html#setEnabled">setEnabled</a></li></ul></li><li><a href="Ratelimiter.html">Ratelimiter</a><ul class='methods'><li data-type='method'><a href="Ratelimiter.html#_sendRequest">_sendRequest</a></li><li data-type='method'><a href="Ratelimiter.html#emitInfo">emitInfo</a></li><li data-type='method'><a href="Ratelimiter.html#request">request</a></li></ul></li><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#aboutUser">aboutUser</a></li><li><a href="global.html#actionButton">actionButton</a></li><li><a href="global.html#addModSubsToSidebar">addModSubsToSidebar</a></li><li><a href="global.html#addToSiteTable">addToSiteTable</a></li><li><a href="global.html#addTrophiesToSidebar">addTrophiesToSidebar</a></li><li><a href="global.html#alert">alert</a></li><li><a href="global.html#apiOauthDELETE">apiOauthDELETE</a></li><li><a href="global.html#apiOauthGET">apiOauthGET</a></li><li><a href="global.html#apiOauthPOST">apiOauthPOST</a></li><li><a href="global.html#approveThing">approveThing</a></li><li><a href="global.html#baseDomain">baseDomain</a></li><li><a href="global.html#betaRelease">betaRelease</a></li><li><a href="global.html#browserName">browserName</a></li><li><a href="global.html#button">button</a></li><li><a href="global.html#checkForActions">checkForActions</a></li><li><a href="global.html#checkLoadConditions">checkLoadConditions</a></li><li><a href="global.html#checkReset">checkReset</a></li><li><a href="global.html#cleanSubredditName">cleanSubredditName</a></li><li><a href="global.html#clearCache">clearCache</a></li><li><a href="global.html#clearNotification">clearNotification</a></li><li><a href="global.html#colorNameToHex">colorNameToHex</a></li><li><a href="global.html#contextTrigger">contextTrigger</a></li><li><a href="global.html#coreLoadedPromise">coreLoadedPromise</a></li><li><a href="global.html#createModNote">createModNote</a></li><li><a href="global.html#createModNotesBadge">createModNotesBadge</a></li><li><a href="global.html#createModNotesPopup">createModNotesPopup</a></li><li><a href="global.html#daysToMilliseconds">daysToMilliseconds</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#debugInformation">debugInformation</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#deleteModNote">deleteModNote</a></li><li><a href="global.html#displayNotes">displayNotes</a></li><li><a href="global.html#distinguishThing">distinguishThing</a></li><li><a href="global.html#domain">domain</a></li><li><a href="global.html#escapeHTML">escapeHTML</a></li><li><a href="global.html#fetchModSubs">fetchModSubs</a></li><li><a href="global.html#fetchNewsNotes">fetchNewsNotes</a></li><li><a href="global.html#figureOutMulti">figureOutMulti</a></li><li><a href="global.html#filterModdable">filterModdable</a></li><li><a href="global.html#flairPost">flairPost</a></li><li><a href="global.html#flairUser">flairUser</a></li><li><a href="global.html#friendUser">friendUser</a></li><li><a href="global.html#generateNoteTableRow">generateNoteTableRow</a></li><li><a href="global.html#getActions">getActions</a></li><li><a href="global.html#getAnonymizedSettings">getAnonymizedSettings</a></li><li><a href="global.html#getBanState">getBanState</a></li><li><a href="global.html#getCache">getCache</a></li><li><a href="global.html#getCurrentUser">getCurrentUser</a></li><li><a href="global.html#getJSON">getJSON</a></li><li><a href="global.html#getLastActive">getLastActive</a></li><li><a href="global.html#getLastVersion">getLastVersion</a></li><li><a href="global.html#getLatestModNote">getLatestModNote</a></li><li><a href="global.html#getModhash">getModhash</a></li><li><a href="global.html#getModlog">getModlog</a></li><li><a href="global.html#getModNotes">getModNotes</a></li><li><a href="global.html#getModSubs">getModSubs</a></li><li><a href="global.html#getRandomNumber">getRandomNumber</a></li><li><a href="global.html#getRatelimit">getRatelimit</a></li><li><a href="global.html#getRecentModNotes">getRecentModNotes</a></li><li><a href="global.html#getReportReasons">getReportReasons</a></li><li><a href="global.html#getRules">getRules</a></li><li><a href="global.html#getSetting">getSetting</a></li><li><a href="global.html#getSettingAsync">getSettingAsync</a></li><li><a href="global.html#getSettings">getSettings</a></li><li><a href="global.html#getSubredditColors">getSubredditColors</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getToolboxDevs">getToolboxDevs</a></li><li><a href="global.html#getUserDetails">getUserDetails</a></li><li><a href="global.html#handleMessage">handleMessage</a></li><li><a href="global.html#handleTBThings">handleTBThings</a></li><li><a href="global.html#handleThing">handleThing</a></li><li><a href="global.html#hideModActionsThings">hideModActionsThings</a></li><li><a href="global.html#htmlDecode">htmlDecode</a></li><li><a href="global.html#htmlEncode">htmlEncode</a></li><li><a href="global.html#humaniseDays">humaniseDays</a></li><li><a href="global.html#icons">icons</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initialLoadPromise">initialLoadPromise</a></li><li><a href="global.html#isConfigValidVersion">isConfigValidVersion</a></li><li><a href="global.html#isEquivalent">isEquivalent</a></li><li><a href="global.html#labelColors">labelColors</a></li><li><a href="global.html#labelNames">labelNames</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#listenerAliases">listenerAliases</a></li><li><a href="global.html#literalRegExp">literalRegExp</a></li><li><a href="global.html#lock">lock</a></li><li><a href="global.html#makeCommentThread">makeCommentThread</a></li><li><a href="global.html#makeQueueOverlay">makeQueueOverlay</a></li><li><a href="global.html#makeSingleComment">makeSingleComment</a></li><li><a href="global.html#makeSubmissionEntry">makeSubmissionEntry</a></li><li><a href="global.html#makeUserSidebar">makeUserSidebar</a></li><li><a href="global.html#markMessageRead">markMessageRead</a></li><li><a href="global.html#markOver18">markOver18</a></li><li><a href="global.html#messageHandlers">messageHandlers</a></li><li><a href="global.html#millisecondsToDays">millisecondsToDays</a></li><li><a href="global.html#minutesToMilliseconds">minutesToMilliseconds</a></li><li><a href="global.html#modbarExists">modbarExists</a></li><li><a href="global.html#moveArrayItem">moveArrayItem</a></li><li><a href="global.html#newModmailSidebar">newModmailSidebar</a></li><li><a href="global.html#niceDateDiff">niceDateDiff</a></li><li><a href="global.html#notification">notification</a></li><li><a href="global.html#overlay">overlay</a></li><li><a href="global.html#pager">pager</a></li><li><a href="global.html#pagerForItems">pagerForItems</a></li><li><a href="global.html#parseComments">parseComments</a></li><li><a href="global.html#parser">parser</a></li><li><a href="global.html#popup">popup</a></li><li><a href="global.html#post">post</a></li><li><a href="global.html#postComment">postComment</a></li><li><a href="global.html#postLink">postLink</a></li><li><a href="global.html#postToWiki">postToWiki</a></li><li><a href="global.html#purify">purify</a></li><li><a href="global.html#purifyObject">purifyObject</a></li><li><a href="global.html#RandomFeedback">RandomFeedback</a></li><li><a href="global.html#RandomQuote">RandomQuote</a></li><li><a href="global.html#readFromWiki">readFromWiki</a></li><li><a href="global.html#regExpEscape">regExpEscape</a></li><li><a href="global.html#reloadIframe">reloadIframe</a></li><li><a href="global.html#reloadToolbox">reloadToolbox</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li><a href="global.html#removeQuotes">removeQuotes</a></li><li><a href="global.html#removeThing">removeThing</a></li><li><a href="global.html#replaceAll">replaceAll</a></li><li><a href="global.html#replaceTokens">replaceTokens</a></li><li><a href="global.html#saneSort">saneSort</a></li><li><a href="global.html#saneSortAs">saneSortAs</a></li><li><a href="global.html#saveSettingsToBrowser">saveSettingsToBrowser</a></li><li><a href="global.html#searchProfile">searchProfile</a></li><li><a href="global.html#sendMessage">sendMessage</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setCache">setCache</a></li><li><a href="global.html#setSetting">setSetting</a></li><li><a href="global.html#setSettingAsync">setSettingAsync</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#settingsToObject">settingsToObject</a></li><li><a href="global.html#showNote">showNote</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#sortBy">sortBy</a></li><li><a href="global.html#standardColors">standardColors</a></li><li><a href="global.html#stickyThread">stickyThread</a></li><li><a href="global.html#stringToColor">stringToColor</a></li><li><a href="global.html#syntaxHighlighterThemeSelect">syntaxHighlighterThemeSelect</a></li><li><a href="global.html#TBLog">TBLog</a></li><li><a href="global.html#tbRedditEvent">tbRedditEvent</a></li><li><a href="global.html#TBsettingsObject">TBsettingsObject</a></li><li><a href="global.html#timeConverterRead">timeConverterRead</a></li><li><a href="global.html#title_to_url">title_to_url</a></li><li><a href="global.html#typeNames">typeNames</a></li><li><a href="global.html#unescapeHTML">unescapeHTML</a></li><li><a href="global.html#unescapeJSON">unescapeJSON</a></li><li><a href="global.html#unfriendUser">unfriendUser</a></li><li><a href="global.html#unlock">unlock</a></li><li><a href="global.html#unMarkOver18">unMarkOver18</a></li><li><a href="global.html#unstickyThread">unstickyThread</a></li><li><a href="global.html#updateModNotesBadge">updateModNotesBadge</a></li><li><a href="global.html#updateModNotesPopup">updateModNotesPopup</a></li><li><a href="global.html#userDetailsPromise">userDetailsPromise</a></li><li><a href="global.html#verifiedSettingsSave">verifiedSettingsSave</a></li><li><a href="global.html#watchForURLChanges">watchForURLChanges</a></li><li><a href="global.html#zlibDeflate">zlibDeflate</a></li><li><a href="global.html#zlibInflate">zlibInflate</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">background/ratelimiter.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Ratelimit handler supporting parallel in-flight requests.
 */
export class Ratelimiter { // eslint-disable-line no-unused-vars,no-redeclare
    constructor () {
        /**
         * Array of data for pending requests.
         * @type {RatelimiterPendingRequest[]}
         */
        this.requestsPending = [];
        /**
         * Set of promises for in-flight requests.
         * @type {Set&lt;Promise&lt;Response>>}
         */
        this.requestsInFlight = new Set();

        /**
         * The number of requests that can be sent before the limit resets
         * @type {number}
         */
        this.ratelimitRemaining = 0;
        /**
         * When the limit will be reset.
         * @type {Date}
         */
        this.ratelimitResetDate = new Date();
        /**
         * ID of the timer currently waiting for the ratelimit reset, if any.
         * @type {number}
         */
        this.resetTimerID = null;
    }

    /**
     * An object containing options that modify how a request is handled.
     * @typedef RatelimiterRequestOptions
     * @property {boolean} options.bypassLimit If true, this request will be
     * sent immediately even if the current ratelimit bucket is empty. Use
     * sparingly, only for requests which block all of Toolbox, and definitely
     * never for mass actions.
     */

    /**
     * An object containing details about a pending request.
     * @typedef RatelimiterPendingRequest
     * @property {any[]} fetchArgs Arguments to fetch()
     * @property {((response: Response) => void)} resolve Function to call if
     * the request is completed successfully
     * @property {(error: Error) => void} reject Function to call if an error
     * occurs while processing the request
     * @property {RatelimiterRequestOptions} options Request handling options
     */

    /**
     * Queues a request.
     * @param {RatelimiterRequestOptions} options Request handling options
     * @param  {...any} fetchArgs Arguments to fetch()
     */
    request (options, ...fetchArgs) {
        // Hard disable ratelimiting by making all requests bypass limits.
        options.bypassLimit = true;

        return new Promise((resolve, reject) => {
            this.requestsPending.push({fetchArgs, resolve, reject, options});
            this._processQueue();
        });
    }

    /**
     * Recursively sends all queued requests.
     * @private
     */
    async _processQueue () {
        // If there are no queued requests, there's nothing to do
        if (this.requestsPending.length &lt;= 0) {
            return;
        }

        // Pull the next queued request
        const nextRequest = this.requestsPending.shift();

        // If this request ignores the limits, send it immediately and move on
        if (nextRequest.options.bypassLimit) {
            this._sendRequest(nextRequest);
            this._processQueue();
            return;
        }

        // If we have as many in-flight requests as we do remaining ratelimit,
        // we can't do anything right now, but we can try again after the reset
        // (but if the ratelimit reset date has passed, allow sending serial
        // requests to get updated ratelimit information)
        if (this.ratelimitRemaining &lt;= this.requestsInFlight.size &amp;&amp; !(Date.now() > this.ratelimitResetDate &amp;&amp; this.requestsInFlight.size === 0)) {
            // We store the reset timer's ID; if we've already got one going, we
            // don't create another
            if (this.resetTimerID == null) {
                this.resetTimerID = setTimeout(() => {
                    // Once we're done waiting, we reset the timer and try again
                    this.resetTimerID = null;
                    this._processQueue();
                }, this.ratelimitResetDate - Date.now());
            }
            return;
        }

        // If we were waiting for the limit to reset but we still have requests
        // left in the current limit, stop waiting for the reset - we'll send
        // something now instead
        if (this.resetTimerID != null) {
            clearInterval(this.resetTimerID);
            this.resetTimerID = null;
        }

        // Send the next request
        await this._sendRequest(nextRequest);

        // Try to send another
        this._processQueue();
    }

    /**
     * Sends a request, updating ratelimit information from response headers. If
     * the response is a 429, the request is added to the front of the queue and
     * retried after the next reset.
     * @param {RatelimiterPendingRequest} request The request to send.
     */
    async _sendRequest (request) {
        // Send the request and add it to the set of in-flight requests
        const requestPromise = fetch(...request.fetchArgs);
        this.requestsInFlight.add(requestPromise);

        // Wait for the response and then remove it from the in-flight set
        let response;
        try {
            response = await requestPromise;
        } catch (error) {
            // If the request rejects, we don't update the ratelimit
            return request.reject(error);
        } finally {
            this.requestsInFlight.delete(requestPromise);
        }

        // Update our information based on response headers
        if (!response.headers.has('x-ratelimit-remaining')) {
            // If the server doesn't report the ratelimit, assume it decreased
            // and will reset at the time we already know
            this.ratelimitRemaining -= 1;
        } else {
            const newRatelimitRemaining = parseInt(response.headers.get('x-ratelimit-remaining'), 10);
            const newRatelimitResetDate = new Date(Date.now() + parseFloat(response.headers.get('x-ratelimit-reset')) * 1000);

            // NOTE: Responses can be received in a different order than the
            //       requests were dispatched, which leads to race conditions.
            //       To avoid this, we only accept values from two types of
            //       responses:
            //       - Responses whose reset date is further into the future
            //         than before, and
            //       - Responses whose reset date is the same as before and
            //         whose limit remaining is lower.
            //       These rules are designed to mitigate the impact of out-of-
            //       order responses on our state; even if several responses are
            //       received out of order, our state will still match the
            //       server state after all responses are processed.

            if (newRatelimitResetDate > this.ratelimitResetDate) {
                this.ratelimitResetDate = newRatelimitResetDate;
                this.ratelimitRemaining = newRatelimitRemaining;
            } else if (newRatelimitResetDate === this.ratelimitResetDate &amp;&amp; newRatelimitRemaining &lt; this.ratelimitRemaining) {
                this.ratelimitRemaining = newRatelimitRemaining;
            }

            console.debug('request completed', {remaining: this.ratelimitRemaining, reset: this.ratelimitResetDate, pending: this.requestsPending.length, inFlight: this.requestsInFlight.size});
        }

        // If the response is a 429, add the request back to the front of the
        // queue and try again, and do not send back the response
        if (response.status === 429) {
            this.requestsPending.unshift(request);
            return;
        }

        // Return the response we got
        request.resolve(response);
    }

    /**
     * Dispatches a tb-ratelimit-info CustomEvent with details about the current
     * ratelimit status in its detail.
     */
    emitInfo () {
        window.dispatchEvent(new CustomEvent('tb-ratelimit-info', {
            detail: {
                reset: this.ratelimitResetDate,
                remaining: this.ratelimitRemaining,
                pending: this.requestsPending.length,
                inFlight: this.requestsInFlight.size,
                waiting: !!this.resetTimerID,
            },
        }));
    }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Sat Sep 10 2022 09:36:39 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
