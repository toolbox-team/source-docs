<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/profile.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-BackgroundPage.html">BackgroundPage</a><ul class='methods'><li data-type='method'><a href="module-BackgroundPage.html#~handleMessage">handleMessage</a></li></ul></li><li><a href="module-CommentNuke.html">CommentNuke</a><ul class='methods'><li data-type='method'><a href="module-CommentNuke.html#~parseComments">parseComments</a></li></ul></li><li><a href="module-ProfilePro.html">ProfilePro</a><ul class='methods'><li data-type='method'><a href="module-ProfilePro.html#~addModSubsToSidebar">addModSubsToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~addToSiteTable">addToSiteTable</a></li><li data-type='method'><a href="module-ProfilePro.html#~addTrophiesToSidebar">addTrophiesToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~filterModdable">filterModdable</a></li><li data-type='method'><a href="module-ProfilePro.html#~hideModActionsThings">hideModActionsThings</a></li><li data-type='method'><a href="module-ProfilePro.html#~makeUserSidebar">makeUserSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~regExpEscape">regExpEscape</a></li><li data-type='method'><a href="module-ProfilePro.html#~searchProfile">searchProfile</a></li></ul></li><li><a href="module-queueOverlay.html">queueOverlay</a><ul class='methods'><li data-type='method'><a href="module-queueOverlay.html#~figureOutMulti">figureOutMulti</a></li><li data-type='method'><a href="module-queueOverlay.html#~makeQueueOverlay">makeQueueOverlay</a></li><li data-type='method'><a href="module-queueOverlay.html#~reloadIframe">reloadIframe</a></li></ul></li><li><a href="module-QueueTools.html">QueueTools</a><ul class='methods'><li data-type='method'><a href="module-QueueTools.html#~checkForActions">checkForActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getActions">getActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getModlog">getModlog</a></li></ul></li><li><a href="module-TBLog.html">TBLog</a></li></ul><h3>Namespaces</h3><ul><li><a href="TBApi.html">TBApi</a><ul class='methods'><li data-type='method'><a href="TBApi.html#.aboutUser">aboutUser</a></li><li data-type='method'><a href="TBApi.html#.apiOauthGET">apiOauthGET</a></li><li data-type='method'><a href="TBApi.html#.apiOauthPOST">apiOauthPOST</a></li><li data-type='method'><a href="TBApi.html#.approveThing">approveThing</a></li><li data-type='method'><a href="TBApi.html#.distinguishThing">distinguishThing</a></li><li data-type='method'><a href="TBApi.html#.flairPost">flairPost</a></li><li data-type='method'><a href="TBApi.html#.flairUser">flairUser</a></li><li data-type='method'><a href="TBApi.html#.friendUser">friendUser</a></li><li data-type='method'><a href="TBApi.html#.getBanState">getBanState</a></li><li data-type='method'><a href="TBApi.html#.getJSON">getJSON</a></li><li data-type='method'><a href="TBApi.html#.getLastActive">getLastActive</a></li><li data-type='method'><a href="TBApi.html#.getRatelimit">getRatelimit</a></li><li data-type='method'><a href="TBApi.html#.getReportReasons">getReportReasons</a></li><li data-type='method'><a href="TBApi.html#.getRules">getRules</a></li><li data-type='method'><a href="TBApi.html#.lock">lock</a></li><li data-type='method'><a href="TBApi.html#.markMessageRead">markMessageRead</a></li><li data-type='method'><a href="TBApi.html#.markOver18">markOver18</a></li><li data-type='method'><a href="TBApi.html#.post">post</a></li><li data-type='method'><a href="TBApi.html#.postComment">postComment</a></li><li data-type='method'><a href="TBApi.html#.postLink">postLink</a></li><li data-type='method'><a href="TBApi.html#.postToWiki">postToWiki</a></li><li data-type='method'><a href="TBApi.html#.readFromWiki">readFromWiki</a></li><li data-type='method'><a href="TBApi.html#.removeThing">removeThing</a></li><li data-type='method'><a href="TBApi.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="TBApi.html#.sendRequest">sendRequest</a></li><li data-type='method'><a href="TBApi.html#.stickyThread">stickyThread</a></li><li data-type='method'><a href="TBApi.html#.unfriendUser">unfriendUser</a></li><li data-type='method'><a href="TBApi.html#.unlock">unlock</a></li><li data-type='method'><a href="TBApi.html#.unMarkOver18">unMarkOver18</a></li><li data-type='method'><a href="TBApi.html#.unstickyThread">unstickyThread</a></li></ul></li><li><a href="TBCore.html">TBCore</a><ul class='members'><li data-type='member'><a href="TBCore.html#.baseDomain">baseDomain</a></li></ul><ul class='methods'><li data-type='method'><a href="TBCore.html#.alert">alert</a></li><li data-type='method'><a href="TBCore.html#.debugInformation">debugInformation</a></li><li data-type='method'><a href="TBCore.html#.getToolboxDevs">getToolboxDevs</a></li><li data-type='method'><a href="TBCore.html#.isConfigValidVersion">isConfigValidVersion</a></li><li data-type='method'><a href="TBCore.html#.link">link</a></li><li data-type='method'><a href="TBCore.html#.notification">notification</a></li><li data-type='method'><a href="TBCore.html#.updateCache">updateCache</a></li></ul></li><li><a href="TBHelpers.html">TBHelpers</a><ul class='methods'><li data-type='method'><a href="TBHelpers.html#.cleanSubredditName">cleanSubredditName</a></li><li data-type='method'><a href="TBHelpers.html#.colorNameToHex">colorNameToHex</a></li><li data-type='method'><a href="TBHelpers.html#.daysToMilliseconds">daysToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.debounce">debounce</a></li><li data-type='method'><a href="TBHelpers.html#.escapeHTML">escapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.getHashParameter">getHashParameter</a></li><li data-type='method'><a href="TBHelpers.html#.getRandomNumber">getRandomNumber</a></li><li data-type='method'><a href="TBHelpers.html#.getTime">getTime</a></li><li data-type='method'><a href="TBHelpers.html#.htmlDecode">htmlDecode</a></li><li data-type='method'><a href="TBHelpers.html#.htmlEncode">htmlEncode</a></li><li data-type='method'><a href="TBHelpers.html#.humaniseDays">humaniseDays</a></li><li data-type='method'><a href="TBHelpers.html#.literalRegExp">literalRegExp</a></li><li data-type='method'><a href="TBHelpers.html#.millisecondsToDays">millisecondsToDays</a></li><li data-type='method'><a href="TBHelpers.html#.minutesToMilliseconds">minutesToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.moveArrayItem">moveArrayItem</a></li><li data-type='method'><a href="TBHelpers.html#.niceDateDiff">niceDateDiff</a></li><li data-type='method'><a href="TBHelpers.html#.removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li data-type='method'><a href="TBHelpers.html#.removeQuotes">removeQuotes</a></li><li data-type='method'><a href="TBHelpers.html#.replaceAll">replaceAll</a></li><li data-type='method'><a href="TBHelpers.html#.replaceTokens">replaceTokens</a></li><li data-type='method'><a href="TBHelpers.html#.saneSort">saneSort</a></li><li data-type='method'><a href="TBHelpers.html#.saneSortAs">saneSortAs</a></li><li data-type='method'><a href="TBHelpers.html#.sortBy">sortBy</a></li><li data-type='method'><a href="TBHelpers.html#.stringToColor">stringToColor</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterISO">timeConverterISO</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterRead">timeConverterRead</a></li><li data-type='method'><a href="TBHelpers.html#.title_to_url">title_to_url</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeHTML">unescapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeJSON">unescapeJSON</a></li><li data-type='method'><a href="TBHelpers.html#.zlibDeflate">zlibDeflate</a></li><li data-type='method'><a href="TBHelpers.html#.zlibInflate">zlibInflate</a></li></ul></li><li><a href="TBui.html">TBui</a><ul class='members'><li data-type='member'><a href="TBui.html#.icons">icons</a></li></ul><ul class='methods'><li data-type='method'><a href="TBui.html#.clearNotification">clearNotification</a></li><li data-type='method'><a href="TBui.html#.contextTrigger">contextTrigger</a></li><li data-type='method'><a href="TBui.html#.makeCommentThread">makeCommentThread</a></li><li data-type='method'><a href="TBui.html#.makeSingleComment">makeSingleComment</a></li><li data-type='method'><a href="TBui.html#.makeSubmissionEntry">makeSubmissionEntry</a></li><li data-type='method'><a href="TBui.html#.popup">popup</a></li><li data-type='method'><a href="TBui.html#.showNotification">showNotification</a></li><li data-type='method'><a href="TBui.html#.tbRedditEvent">tbRedditEvent</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/profile.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/** @module ProfilePro **/
function profilepro () {
    const self = new TB.Module('Profile Pro');
    self.shortname = 'Profile';

    // //Default settings
    self.settings['enabled']['default'] = true;

    self.config['betamode'] = false;

    self.register_setting('alwaysTbProfile', {
        type: 'boolean',
        default: false,
        title: 'Always open toolbox profile overlay on reddit profiles.',
    });

    self.register_setting('profileButtonEnabled', {
        type: 'boolean',
        default: true,
        title: 'Show profile button next to usernames in subs you mod. Allows you to quickly open the toolbox profile on that page.',
    });

    self.register_setting('directProfileToLegacy', {
        type: 'boolean',
        default: false,
        title: 'Open legacy user overview when clicking on profile links.',
    });

    self.register_setting('subredditColor', {
        type: 'boolean',
        default: TB.storage.getSetting('QueueTools', 'subredditColor', false),
        hidden: true,
    });

    self.register_setting('onlyshowInhover', {
        type: 'boolean',
        default: TB.storage.getSetting('GenSettings', 'onlyshowInhover', true),
        hidden: true,
    });

    TB.register_module(self);

    self.init = function () {
        const $body = $('body');
        let filterModThings = false;
        let hideModActions = false;
        let cancelSearch = true;

        const alwaysTbProfile = self.setting('alwaysTbProfile'),
              directProfileToLegacy = self.setting('directProfileToLegacy'),
              subredditColor = self.setting('subredditColor'),
              profileButtonEnabled = self.setting('profileButtonEnabled'),
              onlyshowInhover = self.setting('onlyshowInhover');

        // When profile links are clicked open them in the legacy view directly
        if (directProfileToLegacy) {
            $body.on('click', 'a', function (event) {
                const userProfileRegex = /(?:\.reddit\.com)?\/(?:user|u)\/[^/]*?\/?$/;
                const thisHref = $(this).attr('href');

                // If the url matches and we are not on an old style profile already.
                if (userProfileRegex.test(thisHref) &amp;&amp; !userProfileRegex.test(window.location.href)) {
                    event.preventDefault();
                    const lastChar = thisHref.substr(-1);
                    const newHref = `${thisHref}${lastChar === '/' ? '' : '/'}overview`;
                    if (event.ctrlKey || event.metaKey) {
                        window.open(newHref, '_blank');
                    } else {
                        window.location.href = newHref;
                    }
                }
            });
        }

        /**
         * Will hide or reveal mod actions in the toolbox profile overlay.
         * @function hideModActionsThings
         * @param {boolean} hide determines if actions should be shown or hidden.
         */
        function hideModActionsThings (hide) {
            const $things = $('.tb-thing');
            if (hide) {
                TBCore.forEachChunkedDynamic($things, thing => {
                    const $thing = $(thing);
                    const modAction = $thing.find('.tb-moderator').length;
                    if (modAction) {
                        $thing.addClass('tb-mod-hidden');
                    }
                }, {framerate: 40});
            } else {
                TBCore.forEachChunkedDynamic($things, thing => {
                    const $thing = $(thing);
                    const modAction = $thing.find('.tb-moderator').length;
                    if (modAction) {
                        $thing.removeClass('tb-mod-hidden');
                    }
                }, {framerate: 40});
            }
        }

        /**
         * Will hide or reveal items in the profile overlay that can't be modded.
         * @function filterModdable
         * @param {boolean} hide determines if items should be shown or hidden.
         */
        function filterModdable (hide) {
            const $things = $('.tb-thing');
            if (hide) {
                TBCore.getModSubs(() => {
                    TBCore.forEachChunkedDynamic($things, thing => {
                        const $thing = $(thing);
                        const subreddit = TBHelpers.cleanSubredditName($thing.attr('data-subreddit'));
                        if (!TBCore.mySubs.includes(subreddit)) {
                            $thing.addClass('tb-mod-filtered');
                        }
                    }, {framerate: 40});
                });
            } else {
                TBCore.forEachChunkedDynamic($things, thing => {
                    const $thing = $(thing);
                    $thing.removeClass('tb-mod-filtered');
                }, {framerate: 40});
            }
        }

        /**
         * Adds items to the toolbox profile overlay siteTable element
         * @function addToSiteTable
         * @param {array} data array of reddit things to be added in reddit API format
         * @param {jqueryObject} $siteTable jquery object representing the siteTable
         * @param {string} after reddit thing ID representing the start of the next page. If present will add a "load more" at the end of the siteTable
         * @param {callback} callback callback function
         * @returns {callback} returned when done
         */
        function addToSiteTable (data, $siteTable, after, callback) {
            // prepare comment options for TBUi comment creator.
            const commentOptions = {
                parentLink: true,
                contextLink: true,
                contextPopup: true,
                fullCommentsLink: true,
                overviewData: true,
            };

            const submissionOptions = {};

            // Add subredditColor if applicable.
            if (subredditColor) {
                commentOptions.subredditColor = true;
                submissionOptions.subredditColor = true;
            }

            // Use dynamic chuncking to add all things to the sitetable.
            TBCore.forEachChunkedDynamic(data, entry => {
                // Comment
                if (entry.kind === 't1') {
                    const $comment = TBui.makeSingleComment(entry, commentOptions);
                    if (entry.highlight) {
                        $comment.find('.md p').highlight(entry.highlight, '', true);
                    }
                    $siteTable.append($comment);
                    $('time.timeago').timeago();
                }

                // Submission
                if (entry.kind === 't3') {
                    const $submission = TBui.makeSubmissionEntry(entry, submissionOptions);
                    if (entry.highlight) {
                        $submission.find('.tb-title, .md').highlight(entry.highlight, '', true);
                    }
                    $siteTable.append($submission);
                    $('time.timeago').timeago();
                }
            }).then(() => {
                // More items available on a next page. Add load more element
                if (after) {
                    $siteTable.append(`&lt;div data-after="${after}" class="tb-load-more">load more&lt;/div>`);
                }

                // Fire jsAPI events and apply profile overlay filters where needed.
                setTimeout(() => {
                    TBui.tbRedditEvent($siteTable);
                    if (filterModThings) {
                        filterModdable(true);
                    }
                    if (hideModActions) {
                        hideModActionsThings(true);
                    }

                    // Done, return callback.
                    return callback();
                }, 1000);
            });
        }

        /**
         * Adds the user's trophies to the given sidebar element.
         * @function addTrophiesToSidebar
         * @param {string} user reddit username
         * @param {jqueryObject} $sidebar jquery sidebar element to which the trophies need to be added
         */
        function addTrophiesToSidebar (user, $sidebar) {
            const inputURL = `/user/${user}/trophies.json`;
            TBApi.getJSON(inputURL).then(data => {
                if (Object.keys(data).length > 0 &amp;&amp; data.constructor === Object) {
                    TBStorage.purifyObject(data);
                    const $userTrophies = $(`&lt;div class="tb-user-trophies">
                        &lt;h3> Trophies &lt;/h3>
                    &lt;/div>`).appendTo($sidebar);
                    data.data.trophies.forEach(trophy => {
                        let tropyHTML;

                        const trophyInnerHTML = `
                            &lt;img class="tb-trophy-icon" src="${trophy.data.icon_40}">
                            &lt;br>
                            &lt;span class="tb-trophy-name">${trophy.data.name}&lt;/span>
                            &lt;br>
                            ${trophy.data.description ? `&lt;span class="tb-trophy-description">${trophy.data.description}&lt;/span>` : ''}
                            &lt;br>`;

                        if (trophy.data.url) {
                            tropyHTML = `
                            &lt;div class="tb-trophy-info">
                                &lt;a href="${trophy.data.url}">
                                    ${trophyInnerHTML}
                                &lt;/a>
                            &lt;/div>`;
                        } else {
                            tropyHTML = `
                            &lt;div class="tb-trophy-info">
                                ${trophyInnerHTML}
                            &lt;/div>`;
                        }
                        $userTrophies.append(tropyHTML);
                    });
                }
            });
        }

        /**
         * Adds the user's moderated subs to the given sidebar element.
         * @function addModSubsToSidebar
         * @param {string} user reddit username
         * @param {jqueryObject} $sidebar jquery sidebar element to which the subreddits need to be added
         */
        function addModSubsToSidebar (user, $sidebar) {
            const inputURL = `/user/${user}/moderated_subreddits.json`;
            TBApi.getJSON(inputURL).then(data => {
                if (Object.keys(data).length > 0 &amp;&amp; data.constructor === Object) {
                    TBStorage.purifyObject(data);
                    const $userModSubs = $(`&lt;div class="tb-user-modsubs">
                        &lt;h3> ${data.data.length} Moderated subreddits &lt;/h3>
                    &lt;/div>`).appendTo($sidebar);

                    const $moderatedSubListVisible = $('&lt;ul class="tb-user-modsubs-ul">&lt;/ul>').appendTo($userModSubs);
                    const $moderatedSubListExpanded = $('&lt;ul class="tb-user-modsubs-expand-ul">&lt;/ul>').appendTo($userModSubs);
                    let subCount = 0;

                    TBCore.forEachChunkedDynamic(data.data, subreddit => {
                        subCount++;
                        const subredditName = subreddit.sr,
                              iconImage = subreddit.icon_img,
                              over18 = subreddit.over_18,
                              subscribers = subreddit.subscribers;

                        const liElement = `&lt;li>
                            &lt;a href="${TBCore.link(`/r/${subredditName}`)}" title="${subscribers} subscribers">/r/${subredditName}&lt;/a>
                            ${over18 ? '&lt;span class="tb-nsfw-stamp tb-stamp">&lt;acronym title="Adult content: Not Safe For Work">NSFW&lt;/acronym>&lt;/span>' : ''}
                            ${iconImage ? `&lt;img src="${iconImage}" class="tb-subreddit-icon">` : ''}
                        &lt;/li>`;

                        if (subCount &lt; 10) {
                            $moderatedSubListVisible.append(liElement);
                        } else {
                            $moderatedSubListExpanded.append(liElement);
                        }
                    }, {framerate: 40}).then(() => {
                        if (subCount > 10) {
                            $moderatedSubListVisible.after(`&lt;button class="tb-general-button tb-sidebar-loadmod tb-more" data-action="more">${subCount - 10} more ...&lt;/button>`);
                            $moderatedSubListExpanded.after(`&lt;button class="tb-general-button tb-sidebar-loadmod tb-less" data-action="less">show ${subCount - 10} less&lt;/button>`);

                            $body.on('click', '.tb-sidebar-loadmod', function () {
                                const $this = $(this);
                                const action = $this.attr('data-action');

                                if (action === 'more') {
                                    $moderatedSubListExpanded.show();
                                    $sidebar.find('.tb-sidebar-loadmod.tb-less').show();
                                    $this.hide();
                                } else if (action === 'less') {
                                    $moderatedSubListExpanded.hide();
                                    $sidebar.find('.tb-sidebar-loadmod.tb-more').show();
                                    $this.hide();
                                }
                            });
                        }

                        addTrophiesToSidebar(user, $sidebar);
                    });
                } else {
                    addTrophiesToSidebar(user, $sidebar);
                }
            });
        }

        /**
         * Creates a user sidebar element for the given overlay
         * @function makeUserSidebar
         * @param {string} user reddit username
         * @param {jqueryObject} $overlay jquery overlay element to which the sidebar needs to be added
         */
        function makeUserSidebar (user, $overlay) {
            const $tabWrapper = $overlay.find('.tb-window-tabs-wrapper');
            const inputURL = `/user/${user}/about.json`;
            TBApi.getJSON(inputURL).then(data => {
                TBStorage.purifyObject(data);
                const userThumbnail = data.data.icon_img,
                      userCreated = data.data.created_utc,
                      verifiedMail = data.data.has_verified_email,
                      linkKarma = data.data.link_karma,
                      commentKarma = data.data.comment_karma,
                      displayName = data.data.subreddit.title,
                      publicDescription = data.data.subreddit.public_description;
                const readableCreatedUTC = TBHelpers.timeConverterRead(userCreated),
                      createdTimeAgo = TBHelpers.timeConverterISO(userCreated);

                const $sidebar = $(`&lt;div class="tb-profile-sidebar">
                    ${userThumbnail ? `&lt;img src="${userThumbnail}" class="tb-user-thumbnail">` : ''}
                    &lt;ul class="tb-user-detail-ul">
                        &lt;li>&lt;a href="${TBCore.link(`/user/${user}`)}">/u/${user}&lt;/a>&lt;/li>
                        ${displayName ? `&lt;li>Display name: ${displayName}&lt;/li>` : ''}
                        &lt;li>Link karma: ${linkKarma}&lt;/li>
                        &lt;li>Comment karma: ${commentKarma}&lt;/li>
                        &lt;li>Joined &lt;time title="${readableCreatedUTC}" datetime="${createdTimeAgo}" class="tb-live-timestamp timeago">${createdTimeAgo}&lt;/time>&lt;/li>
                        &lt;li>${verifiedMail ? 'Verified mail' : 'No verified mail'}&lt;/li>
                    &lt;/ul>
                    ${publicDescription ? `
                    &lt;div class="tb-user-description">
                        ${publicDescription}
                    &lt;/div>
                    ` : ''}
                &lt;/div>`);
                $tabWrapper.after($sidebar);
                $sidebar.find('time.timeago').timeago();

                addModSubsToSidebar(user, $sidebar);
            }).catch(error => {
                self.error('Error fetching user information:', inputURL, error);
                // This CSS uses inline-block and having whitespace screws it
                // up, so this HTML has to start immediately after the quote :|
                $tabWrapper.after(`&lt;div class="tb-profile-sidebar">
                    &lt;ul class="tb-user-detail-ul">
                        &lt;li>No user information found - shadowbanned or deleted?&lt;/li>
                    &lt;/ul>
                &lt;/div>`);
            });
        }

        /**
         * Searches a user profile for the given subreddit and/or string
         * @function searchProfile
         * @param {string} user reddit username
         * @param {string} type the listing type that is to be searched
         * @param {string} sortMethod the listing type that is to be searched
         * @param {jqueryObject} $siteTable jquery siteTable element to which the search results need to be added
         * @param {object} options search options
         * @param {string} after reddit thing id indicating the next page
         * @param {boolean} match indicates if there are previous
         * @param {integer} pageCount what page we are on
         * @param {callback} callback callback function
         * @returns {callback} returns true when results have been found, false when none are found
         */
        function searchProfile (user, type, sortMethod, $siteTable, options, after, match, pageCount, callback) {
            pageCount++;
            let hits = match || false;
            const results = [];
            const subredditPattern = options.subredditPattern || false;
            const searchPattern = options.searchPattern || false;

            if (!subredditPattern &amp;&amp; !searchPattern) {
                return callback(false);
            }

            // Cancel search if needed.
            if (cancelSearch) {
                TB.ui.textFeedback('Search canceled', TB.ui.FEEDBACK_NEUTRAL);
                return callback(hits);
            }
            const inputURL = `/user/${user}/${type}.json`;
            TBApi.getJSON(inputURL, {
                raw_json: 1,
                after,
                sort: sortMethod,
                limit: 100,
                t: 'all',
            }).then(data => {
                // Also cancel search here as we really don't need to go over these results.
                if (cancelSearch) {
                    TB.ui.textFeedback('Search canceled', TB.ui.FEEDBACK_NEUTRAL);
                    return callback(hits);
                }
                TB.ui.textFeedback(`Searching profile page ${pageCount} with ${data.data.children.length} items`, TB.ui.FEEDBACK_NEUTRAL);
                TBStorage.purifyObject(data);
                data.data.children.forEach(value => {
                    let hit = false;
                    let subredditMatch = false;
                    let patternMatch = false;
                    if (value.kind === 't1') {
                        subredditMatch = subredditPattern &amp;&amp; subredditPattern.test(value.data.subreddit);
                        patternMatch = searchPattern &amp;&amp; searchPattern.test(value.data.body);
                    }

                    if (value.kind === 't3') {
                        subredditMatch = subredditPattern &amp;&amp; subredditPattern.test(value.data.subreddit);
                        patternMatch = searchPattern &amp;&amp; (value.data.selftext &amp;&amp; searchPattern.test(value.data.selftext) || searchPattern.test(value.data.title));
                    }

                    if (
                        subredditMatch &amp;&amp; !searchPattern ||
                        patternMatch &amp;&amp; !subredditPattern ||
                        subredditMatch &amp;&amp; patternMatch
                    ) {
                        hit = true;
                    }

                    if (hit) {
                        if (searchPattern) {
                            value.highlight = options.searchString;
                        }
                        results.push(value);
                        hits = true;
                    }
                });
                if (!data.data.after) {
                    if (results.length > 0) {
                        addToSiteTable(results, $siteTable, false, () => callback(hits));
                    } else {
                        return callback(hits);
                    }
                } else {
                    if (results.length > 0) {
                        addToSiteTable(results, $siteTable, false, () => {
                            searchProfile(user, type, sortMethod, $siteTable, options, data.data.after, hits, pageCount, found => callback(found));
                        });
                    } else {
                        searchProfile(user, type, sortMethod, $siteTable, options, data.data.after, hits, pageCount, found => callback(found));
                    }
                }
            });
        }

        /**
         * Escapes a string so it is suitable to be inserted in to a regex match
         * @function regExpEscape
         * @param {string} query reddit username
         * @returns {string} string escaped for regex use
         */
        function regExpEscape (query) {
            return query.trim().replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&amp;');
        }

        // Initate user search
        $body.on('submit', '.tb-searchuser', function () {
            TB.ui.longLoadSpinner(true);
            const $this = $(this);
            const $windowContent = $this.closest('.tb-window-content');
            const $siteTable = $windowContent.find('.tb-sitetable');

            const typeListing = $siteTable.attr('data-listing');

            let subredditsearch = $this.find('.tb-subredditsearch').val();
            const usersearch = $this.closest('.tb-page-overlay').attr('data-user'),
                  contentsearch = $this.find('.tb-contentsearch').val(),
                  useSort = $this.find('.tb-search-sort').is(':checked');

            let sortMethod = 'new';

            if (useSort) {
                sortMethod = $siteTable.attr('data-sort');
            }

            subredditsearch = subredditsearch.replace(/\/?r\//g, '');
            subredditsearch = TBHelpers.htmlEncode(subredditsearch);

            $siteTable.removeClass('tb-sitetable-processed');
            $siteTable.empty();

            const searchOptions = {};
            if (subredditsearch) {
                searchOptions.subredditPattern = new RegExp(`^${regExpEscape(subredditsearch)}$`, 'i');
            }
            if (contentsearch) {
                searchOptions.searchPattern = TBHelpers.literalRegExp(contentsearch, 'gi');
                searchOptions.searchString = contentsearch;
            }

            cancelSearch = false;
            $('.tb-cancel-profile-search').show();
            searchProfile(usersearch, typeListing, sortMethod, $siteTable, searchOptions, null, false, 0, results => {
                $('.tb-cancel-profile-search').hide();
                TB.ui.textFeedback('Search complete', TB.ui.FEEDBACK_POSITIVE);
                if (results) {
                    TB.ui.longLoadSpinner(false);
                } else {
                    TB.ui.longLoadSpinner(false);
                    $siteTable.append('&lt;div class="error">no results found&lt;/div>');
                }

                if (cancelSearch) {
                    $siteTable.append('&lt;div class="error">Search was canceled, results might be incomplete&lt;/div>');
                }
            });
            return false;
        });

        // Cancel search
        $body.on('click', '.tb-cancel-profile-search', () => {
            TB.ui.textFeedback('Canceling search', TB.ui.FEEDBACK_NEUTRAL);
            cancelSearch = true;
        });

        function populateSearchSuggestion (subreddit) {
            if (subreddit &amp;&amp; TBCore.mySubs.includes(subreddit)) {
                $body.find('#tb-search-suggest table#tb-search-suggest-list').append(`&lt;tr data-subreddit="${subreddit}">&lt;td>${subreddit}&lt;/td>&lt;/td>&lt;/tr>`);
            }
            $(TBCore.mySubs).each(function () {
                if (this !== subreddit) {
                    $body.find('#tb-search-suggest table#tb-search-suggest-list').append(`&lt;tr data-subreddit="${this}">&lt;td>${this}&lt;/td>&lt;/td>&lt;/tr>`);
                }
            });
        }

        function liveSearch (liveSearchValue) {
            $body.find('#tb-search-suggest table#tb-search-suggest-list tr').each(function () {
                const $this = $(this),
                      subredditName = $this.attr('data-subreddit');

                if (subredditName.toUpperCase().indexOf(liveSearchValue.toUpperCase()) &lt; 0) {
                    $this.hide();
                } else {
                    $this.show();
                }
            });
        }

        function initSearchSuggestion (subreddit) {
            if (!$body.find('#tb-search-suggest').length) {
                $body.append('&lt;div id="tb-search-suggest" style="display: none;">&lt;table id="tb-search-suggest-list">&lt;/table>&lt;/div>');
                TBCore.getModSubs(() => {
                    populateSearchSuggestion(subreddit);
                });
            }

            $body.on('focus', '.tb-subredditsearch', function () {
                const offset = $(this).offset();
                const offsetLeft = offset.left;
                const offsetTop = offset.top + 26;

                $body.find('#tb-search-suggest').css({
                    left: `${offsetLeft}px`,
                    top: `${offsetTop}px`,
                });

                if (!$body.find('#tb-search-suggest').is(':visible')) {
                    $body.find('#tb-search-suggest').show();
                }
                const liveSearchValue = $(this).val();
                liveSearch(liveSearchValue);
            });

            $body.find('.tb-subredditsearch').keyup(function () {
                const liveSearchValue = $(this).val();
                liveSearch(liveSearchValue);
            });

            $(document).on('click', event => {
                if (!$(event.target).closest('#tb-search-suggest').length &amp;&amp; !$(event.target).closest('.tb-subredditsearch').length) {
                    $body.find('#tb-search-suggest').hide();
                }
            });

            $body.on('click', '#tb-search-suggest-list tr', function () {
                const subSuggestion = $(this).attr('data-subreddit');
                $body.find('.tb-subredditsearch:visible').val(subSuggestion);
                $body.find('#tb-search-suggest').hide();
            });
        }

        function makeProfile (user, type, options) {
            const sort = options.sort || 'new';
            const renew = options.renew || false;
            const after = options.after || '';
            const subreddit = options.subreddit || '';
            TB.ui.longLoadSpinner(true);

            let $overlay = $body.find('.tb-profile-overlay');

            if (!$overlay.length) {
                $overlay = TB.ui.overlay(
                    `Toolbox profile for /u/${user}`,
                    [
                        {
                            title: 'overview',
                            tooltip: 'Overview profile.',
                            content: `
                                &lt;div class="tb-profile-options tb-profile-options-overview">&lt;/div>
                                &lt;div class="tb-sitetable tb-sitetable-overview">&lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'submitted',
                            tooltip: 'submitted profile.',
                            content: `
                                &lt;div class="tb-profile-options tb-profile-options-submitted">&lt;/div>
                                &lt;div class="tb-sitetable tb-sitetable-submitted">&lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'comments',
                            tooltip: 'comment profile.',
                            content: `
                                &lt;div class="tb-profile-options tb-profile-options-comments">&lt;/div>
                                &lt;div class="tb-sitetable tb-sitetable-comments">&lt;/div>
                            `,
                            footer: '',
                        },
                    ],
                    [], // extra header buttons
                    'tb-profile-overlay tb-overlay-horizontal-tabs', // class
                    false, // single overriding footer
                    {
                        user,
                    }
                ).appendTo('body');

                $body.css('overflow', 'hidden');

                makeUserSidebar(user, $overlay);
                $body.on('click', '.tb-profile-overlay .tb-window-header .close', () => {
                    // Cancel any ongoing search
                    cancelSearch = true;
                    $('.tb-profile-overlay').remove();
                    $body.css('overflow', 'auto');
                    filterModThings = false;
                });
            }
            const $siteTable = $overlay.find(`.tb-sitetable-${type}`);
            const $options = $overlay.find(`.tb-profile-options-${type}`);

            $siteTable.attr({
                'data-user': user,
                'data-sort': sort,
                'data-listing': type,
                't': 'all',
            });

            if ($siteTable.hasClass('tb-sitetable-processed') &amp;&amp; !renew &amp;&amp; !after) {
                TB.ui.longLoadSpinner(false);
                return;
            }
            // Prevent some issues with people selecting a new sort method while toolbox is still busy.
            $options.hide();

            // Filter options
            let $filterOptions = $options.find('.tb-filter-options');
            if (!$filterOptions.length) {
                $filterOptions = $(`
                &lt;div class="tb-filter-options">
                    &lt;select class="tb-sort-select tb-general-button" data-type="${type}">
                        &lt;option value="new">new&lt;/option>
                        &lt;option value="top">top&lt;/option>
                        &lt;option value="controversial">controversial&lt;/option>
                        &lt;option value="hot">hot&lt;/option>
                    &lt;/select>
                    &lt;button class="tb-general-button tb-filter-moddable">${filterModThings ? 'Show unmoddable' : 'Hide unmoddable'}&lt;/button>
                    &lt;button name="hideModComments" class="tb-hide-mod-comments tb-general-button">${hideModActions ? 'Show mod actions' : 'Hide mod actions'}&lt;/a>
                &lt;/div>`).appendTo($options);

                $options.append(`&lt;form class="tb-searchuser">
                        search: &lt;input type="text" placeholder="subreddit" class="tb-subredditsearch tb-input tb-search-input"> &lt;input type="text" placeholder="content (optional)" class="tb-contentsearch tb-input tb-search-input">
                        &lt;label> &lt;input type="checkbox" class="tb-search-sort"> use sort selection &lt;/label>
                        &lt;input type="submit" value=" search " class="tb-action-button">
                &lt;/form>
                &lt;input type="button" value="cancel search" class="tb-action-button tb-cancel-profile-search">`);
                initSearchSuggestion(subreddit);
            }

            const $sortSelect = $filterOptions.find('.tb-sort-select');

            $sortSelect.val(sort);

            if (!after) {
                $siteTable.addClass('tb-sitetable-processed');
                $siteTable.empty();
            }

            TBui.switchOverlayTab('tb-profile-overlay', type);
            const inputURL = `/user/${user}/${type}.json`;
            TBApi.getJSON(inputURL, {
                raw_json: 1,
                after,
                sort,
                limit: 25,
            }).then(data => {
                TBStorage.purifyObject(data);
                let after = false;
                if (data.data.after) {
                    after = data.data.after;
                }
                addToSiteTable(data.data.children, $siteTable, after, () => {
                    TB.ui.longLoadSpinner(false);
                    $options.show();
                });
            }).catch(error => {
                self.error('Error fetching profile activity:', inputURL, error);
                $('.tb-profile-overlay .tb-window-content').html(`
                    &lt;h1>No activity found&lt;/h1>
                    &lt;p>Reddit doesn't seem to have anything for this account. Try checking your subreddit's moderation log to find posts and comments from them.&lt;/p>
                `);
                TB.ui.longLoadSpinner(false);
            });
        }

        $body.on('click', '.tb-load-more', function () {
            const $this = $(this);
            const $siteTable = $this.closest('.tb-sitetable');
            const after = $this.attr('data-after'),
                  user = $siteTable.attr('data-user'),
                  listing = $siteTable.attr('data-listing'),
                  sort = $siteTable.attr('data-sort');
            makeProfile(user, listing, {sort, renew: false, after});

            $this.remove();
        });

        $body.on('change keydown', '.tb-sort-select', function () {
            const $this = $(this);
            const newSort = $this.val(),
                  user = $this.closest('.tb-page-overlay').attr('data-user'),
                  listing = $this.attr('data-type');
            makeProfile(user, listing, {sort: newSort, renew: true});
        });

        $body.on('click', '.tb-filter-moddable', () => {
            const $filterMod = $body.find('.tb-filter-moddable');
            if (filterModThings) {
                filterModdable(false);
                $filterMod.text('Hide unmoddable');
                filterModThings = false;
            } else {
                filterModdable(true);
                $filterMod.text('Show unmoddable');
                filterModThings = true;
            }
        });

        $body.on('click', '.tb-hide-mod-comments', () => {
            const $hideMod = $('.tb-hide-mod-comments');
            if (hideModActions) {
                hideModActionsThings(false);
                $hideMod.text('Hide mod actions');
                hideModActions = false;
            } else {
                hideModActionsThings(true);
                $hideMod.text('Show mod actions');
                hideModActions = true;
            }
        });

        $body.on('click', '.tb-profile-overlay .tb-window-tabs a', function () {
            // Cancel any ongoing profile search first.
            cancelSearch = true;

            // Start creating specific listing overlay tab
            const $this = $(this);
            const listing = $this.attr('data-module'),
                  user = $this.closest('.tb-page-overlay').attr('data-user');
            makeProfile(user, listing, {sort: 'new'});
        });

        window.addEventListener('TBNewPage', event => {
            const popupTypes = ['comments', 'submitted', 'overview'];
            if (event.detail.pageType === 'userProfile' &amp;&amp; popupTypes.includes(event.detail.pageDetails.listing)) {
                const user = event.detail.pageDetails.user,
                      listing = event.detail.pageDetails.listing;
                TBui.contextTrigger('tb-user-profile', {
                    addTrigger: true,
                    triggerText: 'toolbox profile',
                    triggerIcon: TBui.icons.profile,
                    title: `Show toolbox profile for /u/${user}`,
                    dataAttributes: {
                        user,
                        listing,
                    },
                });
                if (alwaysTbProfile) {
                    makeProfile(user, listing, {sort: 'new', renew: false});
                }
            } else {
                TBui.contextTrigger('tb-user-profile', {addTrigger: false});
            }
        });

        if (profileButtonEnabled) {
            TB.listener.on('author', e => {
                const $target = $(e.target);

                if (!$target.closest('.tb-profile-overlay').length &amp;&amp; (!onlyshowInhover || TBCore.isOldReddit || TBCore.isNewModmail)) {
                    const author = e.detail.data.author;
                    const subreddit = e.detail.data.subreddit.name;
                    TBCore.getModSubs(() => {
                        if (TBCore.modsSub(subreddit)) {
                            const profileButton = `&lt;a href="javascript:;" class="tb-user-profile tb-bracket-button" data-listing="overview" data-user="${author}" data-subreddit="${subreddit}" title="view &amp; filter user's profile in toolbox overlay">P&lt;/a>`;
                            requestAnimationFrame(() => {
                                $target.append(profileButton);
                            });
                        }
                    });
                }
            });

            TB.listener.on('userHovercard', e => {
                const $target = $(e.target);
                const subreddit = e.detail.data.subreddit.name;
                const author = e.detail.data.user.username;

                TBCore.getModSubs(() => {
                    if (TBCore.modsSub(subreddit)) {
                        const profileButton = `&lt;a href="javascript:;" class="tb-user-profile tb-bracket-button" data-listing="overview" data-user="${author}" data-subreddit="${subreddit}" title="view &amp; filter user's profile in toolbox overlay">Toolbox Profile View&lt;/a>`;
                        $target.append(profileButton);
                    }
                });
            });
        }

        $body.on('click', '#tb-user-profile, .tb-user-profile', function () {
            const $this = $(this);
            const user = $this.attr('data-user'),
                  listing = $this.attr('data-listing'),
                  subreddit = $this.attr('data-subreddit');

            const options = {
                sort: 'new',
                renew: false,
            };
            if (subreddit) {
                options.subreddit = subreddit;
            }
            makeProfile(user, listing, options);
        });
    };
}

window.addEventListener('TBModuleLoaded', () => {
    profilepro();
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sun Oct 04 2020 21:11:43 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
