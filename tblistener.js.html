<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>tblistener.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-BackgroundPage.html">BackgroundPage</a><ul class='methods'><li data-type='method'><a href="module-BackgroundPage.html#~handleMessage">handleMessage</a></li></ul></li><li><a href="module-CommentNuke.html">CommentNuke</a><ul class='methods'><li data-type='method'><a href="module-CommentNuke.html#~parseComments">parseComments</a></li></ul></li><li><a href="module-ProfilePro.html">ProfilePro</a><ul class='methods'><li data-type='method'><a href="module-ProfilePro.html#~addModSubsToSidebar">addModSubsToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~addToSiteTable">addToSiteTable</a></li><li data-type='method'><a href="module-ProfilePro.html#~addTrophiesToSidebar">addTrophiesToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~filterModdable">filterModdable</a></li><li data-type='method'><a href="module-ProfilePro.html#~hideModActionsThings">hideModActionsThings</a></li><li data-type='method'><a href="module-ProfilePro.html#~makeUserSidebar">makeUserSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~regExpEscape">regExpEscape</a></li><li data-type='method'><a href="module-ProfilePro.html#~searchProfile">searchProfile</a></li></ul></li><li><a href="module-queueOverlay.html">queueOverlay</a><ul class='methods'><li data-type='method'><a href="module-queueOverlay.html#~figureOutMulti">figureOutMulti</a></li><li data-type='method'><a href="module-queueOverlay.html#~makeQueueOverlay">makeQueueOverlay</a></li><li data-type='method'><a href="module-queueOverlay.html#~reloadIframe">reloadIframe</a></li></ul></li><li><a href="module-QueueTools.html">QueueTools</a><ul class='methods'><li data-type='method'><a href="module-QueueTools.html#~checkForActions">checkForActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getActions">getActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getModlog">getModlog</a></li></ul></li><li><a href="module-TBLog.html">TBLog</a></li></ul><h3>Namespaces</h3><ul><li><a href="TBApi.html">TBApi</a><ul class='methods'><li data-type='method'><a href="TBApi.html#.aboutUser">aboutUser</a></li><li data-type='method'><a href="TBApi.html#.apiOauthGET">apiOauthGET</a></li><li data-type='method'><a href="TBApi.html#.apiOauthPOST">apiOauthPOST</a></li><li data-type='method'><a href="TBApi.html#.approveThing">approveThing</a></li><li data-type='method'><a href="TBApi.html#.distinguishThing">distinguishThing</a></li><li data-type='method'><a href="TBApi.html#.flairPost">flairPost</a></li><li data-type='method'><a href="TBApi.html#.flairUser">flairUser</a></li><li data-type='method'><a href="TBApi.html#.friendUser">friendUser</a></li><li data-type='method'><a href="TBApi.html#.getBanState">getBanState</a></li><li data-type='method'><a href="TBApi.html#.getJSON">getJSON</a></li><li data-type='method'><a href="TBApi.html#.getLastActive">getLastActive</a></li><li data-type='method'><a href="TBApi.html#.getRatelimit">getRatelimit</a></li><li data-type='method'><a href="TBApi.html#.getReportReasons">getReportReasons</a></li><li data-type='method'><a href="TBApi.html#.getRules">getRules</a></li><li data-type='method'><a href="TBApi.html#.lock">lock</a></li><li data-type='method'><a href="TBApi.html#.markMessageRead">markMessageRead</a></li><li data-type='method'><a href="TBApi.html#.markOver18">markOver18</a></li><li data-type='method'><a href="TBApi.html#.post">post</a></li><li data-type='method'><a href="TBApi.html#.postComment">postComment</a></li><li data-type='method'><a href="TBApi.html#.postLink">postLink</a></li><li data-type='method'><a href="TBApi.html#.postToWiki">postToWiki</a></li><li data-type='method'><a href="TBApi.html#.readFromWiki">readFromWiki</a></li><li data-type='method'><a href="TBApi.html#.removeThing">removeThing</a></li><li data-type='method'><a href="TBApi.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="TBApi.html#.sendRequest">sendRequest</a></li><li data-type='method'><a href="TBApi.html#.stickyThread">stickyThread</a></li><li data-type='method'><a href="TBApi.html#.unfriendUser">unfriendUser</a></li><li data-type='method'><a href="TBApi.html#.unlock">unlock</a></li><li data-type='method'><a href="TBApi.html#.unMarkOver18">unMarkOver18</a></li><li data-type='method'><a href="TBApi.html#.unstickyThread">unstickyThread</a></li></ul></li><li><a href="TBCore.html">TBCore</a><ul class='members'><li data-type='member'><a href="TBCore.html#.baseDomain">baseDomain</a></li></ul><ul class='methods'><li data-type='method'><a href="TBCore.html#.alert">alert</a></li><li data-type='method'><a href="TBCore.html#.debugInformation">debugInformation</a></li><li data-type='method'><a href="TBCore.html#.getToolboxDevs">getToolboxDevs</a></li><li data-type='method'><a href="TBCore.html#.isConfigValidVersion">isConfigValidVersion</a></li><li data-type='method'><a href="TBCore.html#.link">link</a></li><li data-type='method'><a href="TBCore.html#.notification">notification</a></li><li data-type='method'><a href="TBCore.html#.updateCache">updateCache</a></li></ul></li><li><a href="TBHelpers.html">TBHelpers</a><ul class='methods'><li data-type='method'><a href="TBHelpers.html#.cleanSubredditName">cleanSubredditName</a></li><li data-type='method'><a href="TBHelpers.html#.colorNameToHex">colorNameToHex</a></li><li data-type='method'><a href="TBHelpers.html#.daysToMilliseconds">daysToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.debounce">debounce</a></li><li data-type='method'><a href="TBHelpers.html#.escapeHTML">escapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.getRandomNumber">getRandomNumber</a></li><li data-type='method'><a href="TBHelpers.html#.getTime">getTime</a></li><li data-type='method'><a href="TBHelpers.html#.htmlDecode">htmlDecode</a></li><li data-type='method'><a href="TBHelpers.html#.htmlEncode">htmlEncode</a></li><li data-type='method'><a href="TBHelpers.html#.humaniseDays">humaniseDays</a></li><li data-type='method'><a href="TBHelpers.html#.literalRegExp">literalRegExp</a></li><li data-type='method'><a href="TBHelpers.html#.millisecondsToDays">millisecondsToDays</a></li><li data-type='method'><a href="TBHelpers.html#.minutesToMilliseconds">minutesToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.moveArrayItem">moveArrayItem</a></li><li data-type='method'><a href="TBHelpers.html#.niceDateDiff">niceDateDiff</a></li><li data-type='method'><a href="TBHelpers.html#.removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li data-type='method'><a href="TBHelpers.html#.removeQuotes">removeQuotes</a></li><li data-type='method'><a href="TBHelpers.html#.replaceAll">replaceAll</a></li><li data-type='method'><a href="TBHelpers.html#.replaceTokens">replaceTokens</a></li><li data-type='method'><a href="TBHelpers.html#.saneSort">saneSort</a></li><li data-type='method'><a href="TBHelpers.html#.saneSortAs">saneSortAs</a></li><li data-type='method'><a href="TBHelpers.html#.sortBy">sortBy</a></li><li data-type='method'><a href="TBHelpers.html#.stringToColor">stringToColor</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterRead">timeConverterRead</a></li><li data-type='method'><a href="TBHelpers.html#.title_to_url">title_to_url</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeHTML">unescapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeJSON">unescapeJSON</a></li><li data-type='method'><a href="TBHelpers.html#.zlibDeflate">zlibDeflate</a></li><li data-type='method'><a href="TBHelpers.html#.zlibInflate">zlibInflate</a></li></ul></li><li><a href="TBui.html">TBui</a><ul class='members'><li data-type='member'><a href="TBui.html#.icons">icons</a></li></ul><ul class='methods'><li data-type='method'><a href="TBui.html#.clearNotification">clearNotification</a></li><li data-type='method'><a href="TBui.html#.contextTrigger">contextTrigger</a></li><li data-type='method'><a href="TBui.html#.makeCommentThread">makeCommentThread</a></li><li data-type='method'><a href="TBui.html#.makeSingleComment">makeSingleComment</a></li><li data-type='method'><a href="TBui.html#.makeSubmissionEntry">makeSubmissionEntry</a></li><li data-type='method'><a href="TBui.html#.overlay">overlay</a></li><li data-type='method'><a href="TBui.html#.pager">pager</a></li><li data-type='method'><a href="TBui.html#.pagerForItems">pagerForItems</a></li><li data-type='method'><a href="TBui.html#.popup">popup</a></li><li data-type='method'><a href="TBui.html#.showNotification">showNotification</a></li><li data-type='method'><a href="TBui.html#.tbRedditEvent">tbRedditEvent</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">tblistener.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
(function () {
    const logger = TBLog('TBListener');
    /**
     * Event listener aliases. Allows you to listen for `author` and get `postAuthor` and `commentAuthor` events,
     * for example.
     * @type {Object.&lt;string, Array&lt;string>>}
     */

    const listenerAliases = {
        postAuthor: ['author'],
        commentAuthor: ['author'],
        TBcommentAuthor: ['author'],
        TBpostAuthor: ['author'],
        TBcomment: ['comment'],
        TBcommentOldReddit: ['comment'],
        TBpost: ['post'],
        TBuserHovercard: ['userHovercard'],
        TBmodmailCommentAuthor: ['author'],
    };

    /**
     * We run this inside a try catch
     * so that if any jobs error, we
     * are able to recover and continue
     * to flush the batch until it's empty.
     *
     * @private
     */
    function runTasks (tasks) {
        $.log('run tasks', false, 'TBListener');
        let task;
        while ((task = tasks.shift())) {
            task();
        }
    }

    /**
     * Remove an item from an Array.
     *
     * @param  {Array} array
     * @param  {*} item
     * @return {Boolean}
     */
    function remove (array, item) {
        const index = array.indexOf(item);
        return !!~index &amp;&amp; !!array.splice(index, 1);
    }

    class TBListener {
        /**
         * Create a new instance of TBListener. Nothing happens yet until TBListener.start() has been called
         */
        constructor () {
            // Simple array holding callbacks waiting to be handled.
            // If you want to put something in here directly, make sure to call scheduleFlush()
            this.queue = [];

            // Holding areference to the bound function so `removeEventListener` can be called later
            this.boundFunc = this.listener.bind(this);

            // Object holding all registered listeners.
            // Keys are listener names, with arrays of callbacks as their values
            this.listeners = {};

            // Used by stop() and start()
            this.started = false;

            // If you assign a function to this, every single `reddit` event will go to it
            this.debugFunc = null;

            this.scheduled = false;
        }

        /**
         * Starts the TBListener instance by registering an event listener for `reddit` events
         *
         * A `TBListenerLoaded` event is fired when everything is ready.
         */
        start () {
            if (!this.started) {
                const loadedEvent = new CustomEvent('TBListenerLoaded');

                const meta = document.createElement('meta');
                meta.name = 'jsapi.consumer';
                meta.content = 'toolbox';
                document.head.appendChild(meta);

                const readyEvent = new CustomEvent('reddit.ready');

                document.addEventListener('reddit', this.boundFunc, true);
                document.addEventListener('tbReddit', this.boundFunc, true);

                document.dispatchEvent(loadedEvent);
                meta.dispatchEvent(readyEvent);

                this.started = true;
            }
        }

        /**
         * Unregisters this instance's event listener
         */
        stop () {
            if (this.started) {
                document.removeEventListener('reddit', this.boundFunc);
                document.removeEventListener('tbReddit', this.boundFunc);
                this.started = false;
            }
        }

        /**
         * Register an event listener for a given event name for a callback.
         *
         * @param {string} Name of event
         * @param {TBListener~listenerCallback} Callback
         */
        on (event, callback) {
            if (!this.listeners[event]) {
                this.listeners[event] = [];
            }

            this.listeners[event].push(callback);
        }

        /**
         * Callback for a `reddit` event.
         * The callback's `this` is event.target
         *
         * @callback TBListener~listenerCallback
         * @param {CustomEvent} event
         * @param {string} responseMessage
         * @this HTMLElement
         */

        /**
         * The function that gets registered as a global event listener for `reddit` events.
         *
         * @param {CustomEvent}
         * @private
         */
        listener (event) {
            const eventType = event.detail.type;
            const target = event.target.querySelector('[data-name="toolbox"]');

            // If there is no target this is not for us.
            if (!target) {
                return;
            }

            // We already have seen this attribute and do not need duplicates.
            if (target.classList.contains('tb-frontend-container')) {
                return;
            }

            const $target = $(target);
            $target.data('tb-details', event.detail);
            $target.data('tb-type', event.detail.type);
            target.setAttribute('data-tb-type', event.detail.type);
            target.classList.add('tb-frontend-container');

            const internalEvent = {
                detail: event.detail,
                target,
            };

            // See if there's any registered listeners listening for eventType
            if (Array.isArray(this.listeners[eventType])) {
                for (const listener of this.listeners[eventType]) {
                    this.queue.push(listener.bind(target, internalEvent));
                }
            }

            // Check and see if there are any aliases for `eventType` and run those on the queue
            if (Array.isArray(listenerAliases[eventType])) {
                for (const alias of listenerAliases[eventType]) {
                    if (Array.isArray(this.listeners[alias])) {
                        for (const listener of this.listeners[alias]) {
                            this.queue.push(listener.bind(target, internalEvent));
                        }
                    }
                }
            }

            // Run the debug function on the queue, if there's any
            if (this.debugFunc) {
                this.queue.push(this.debugFunc.bind(target, internalEvent));
            }

            // Flush the queue
            this.scheduleFlush();
        }

        /**
         * Clears a scheduled 'read' or 'write' task.
         *
         * @param {Object} task
         * @return {Boolean} success
         * @public
         */
        clear (task) {
            return remove(this.queue, task);
        }

        /**
         * Schedules a new read/write
         * batch if one isn't pending.
         *
         * @private
         */
        scheduleFlush () {
            if (!this.scheduled) {
                this.scheduled = true;
                requestAnimationFrame(this.flush.bind(this));
            }
        }

        /**
         * Runs queued tasks.
         *
         * Errors are caught and thrown by default.
         * If a `.catch` function has been defined
         * it is called instead.
         *
         * @private
         */
        flush () {
            const queue = this.queue;
            let error;

            try {
                runTasks(queue);
            } catch (e) {
                error = e;
            }

            this.scheduled = false;

            // If the batch errored we may still have tasks queued
            if (queue.length) {
                this.scheduleFlush();
            }

            if (error) {
                logger.error('task errored', error.message);
                if (this.catch) {
                    this.catch(error);
                } else {
                    throw error;
                }
            }
        }
    }

    window.TBListener = new TBListener();
})();
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Thu Jan 21 2021 22:59:48 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
