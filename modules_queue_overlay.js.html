<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/queue_overlay.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-BackgroundPage.html">BackgroundPage</a><ul class='methods'><li data-type='method'><a href="module-BackgroundPage.html#~handleMessage">handleMessage</a></li></ul></li><li><a href="module-CommentNuke.html">CommentNuke</a><ul class='methods'><li data-type='method'><a href="module-CommentNuke.html#~parseComments">parseComments</a></li></ul></li><li><a href="module-ProfilePro.html">ProfilePro</a><ul class='methods'><li data-type='method'><a href="module-ProfilePro.html#~addModSubsToSidebar">addModSubsToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~addToSiteTable">addToSiteTable</a></li><li data-type='method'><a href="module-ProfilePro.html#~addTrophiesToSidebar">addTrophiesToSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~filterModdable">filterModdable</a></li><li data-type='method'><a href="module-ProfilePro.html#~hideModActionsThings">hideModActionsThings</a></li><li data-type='method'><a href="module-ProfilePro.html#~makeUserSidebar">makeUserSidebar</a></li><li data-type='method'><a href="module-ProfilePro.html#~regExpEscape">regExpEscape</a></li><li data-type='method'><a href="module-ProfilePro.html#~searchProfile">searchProfile</a></li></ul></li><li><a href="module-queueOverlay.html">queueOverlay</a><ul class='methods'><li data-type='method'><a href="module-queueOverlay.html#~figureOutMulti">figureOutMulti</a></li><li data-type='method'><a href="module-queueOverlay.html#~makeQueueOverlay">makeQueueOverlay</a></li><li data-type='method'><a href="module-queueOverlay.html#~reloadIframe">reloadIframe</a></li></ul></li><li><a href="module-QueueTools.html">QueueTools</a><ul class='methods'><li data-type='method'><a href="module-QueueTools.html#~checkForActions">checkForActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getActions">getActions</a></li><li data-type='method'><a href="module-QueueTools.html#~getModlog">getModlog</a></li></ul></li><li><a href="module-TBLog.html">TBLog</a></li></ul><h3>Namespaces</h3><ul><li><a href="TBApi.html">TBApi</a><ul class='methods'><li data-type='method'><a href="TBApi.html#.apiOauthRequest">apiOauthRequest</a></li><li data-type='method'><a href="TBApi.html#.getHead">getHead</a></li><li data-type='method'><a href="TBApi.html#.getJSON">getJSON</a></li><li data-type='method'><a href="TBApi.html#.post">post</a></li><li data-type='method'><a href="TBApi.html#.sendRequest">sendRequest</a></li></ul></li><li><a href="TBCore.html">TBCore</a><ul class='methods'><li data-type='method'><a href="TBCore.html#.alert">alert</a></li><li data-type='method'><a href="TBCore.html#.debugInformation">debugInformation</a></li><li data-type='method'><a href="TBCore.html#.getToolboxDevs">getToolboxDevs</a></li><li data-type='method'><a href="TBCore.html#.isConfigValidVersion">isConfigValidVersion</a></li><li data-type='method'><a href="TBCore.html#.link">link</a></li><li data-type='method'><a href="TBCore.html#.notification">notification</a></li><li data-type='method'><a href="TBCore.html#.updateCache">updateCache</a></li></ul></li><li><a href="TBHelpers.html">TBHelpers</a><ul class='methods'><li data-type='method'><a href="TBHelpers.html#.cleanSubredditName">cleanSubredditName</a></li><li data-type='method'><a href="TBHelpers.html#.colorNameToHex">colorNameToHex</a></li><li data-type='method'><a href="TBHelpers.html#.daysToMilliseconds">daysToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.escapeHTML">escapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.getRandomNumber">getRandomNumber</a></li><li data-type='method'><a href="TBHelpers.html#.getTime">getTime</a></li><li data-type='method'><a href="TBHelpers.html#.humaniseDays">humaniseDays</a></li><li data-type='method'><a href="TBHelpers.html#.isOdd">isOdd</a></li><li data-type='method'><a href="TBHelpers.html#.millisecondsToDays">millisecondsToDays</a></li><li data-type='method'><a href="TBHelpers.html#.minutesToMilliseconds">minutesToMilliseconds</a></li><li data-type='method'><a href="TBHelpers.html#.moveArrayItem">moveArrayItem</a></li><li data-type='method'><a href="TBHelpers.html#.niceDateDiff">niceDateDiff</a></li><li data-type='method'><a href="TBHelpers.html#.removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li data-type='method'><a href="TBHelpers.html#.replaceAll">replaceAll</a></li><li data-type='method'><a href="TBHelpers.html#.replaceTokens">replaceTokens</a></li><li data-type='method'><a href="TBHelpers.html#.saneSort">saneSort</a></li><li data-type='method'><a href="TBHelpers.html#.saneSortAs">saneSortAs</a></li><li data-type='method'><a href="TBHelpers.html#.sortBy">sortBy</a></li><li data-type='method'><a href="TBHelpers.html#.stringFormat">stringFormat</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterISO">timeConverterISO</a></li><li data-type='method'><a href="TBHelpers.html#.timeConverterRead">timeConverterRead</a></li><li data-type='method'><a href="TBHelpers.html#.title_to_url">title_to_url</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeHTML">unescapeHTML</a></li><li data-type='method'><a href="TBHelpers.html#.unescapeJSON">unescapeJSON</a></li></ul></li><li><a href="TBui.html">TBui</a><ul class='methods'><li data-type='method'><a href="TBui.html#.clearNotification">clearNotification</a></li><li data-type='method'><a href="TBui.html#.contextTrigger">contextTrigger</a></li><li data-type='method'><a href="TBui.html#.makeCommentThread">makeCommentThread</a></li><li data-type='method'><a href="TBui.html#.makeSingleComment">makeSingleComment</a></li><li data-type='method'><a href="TBui.html#.makeSubmissionEntry">makeSubmissionEntry</a></li><li data-type='method'><a href="TBui.html#.popup">popup</a></li><li data-type='method'><a href="TBui.html#.showNotification">showNotification</a></li><li data-type='method'><a href="TBui.html#.tbRedditEvent">tbRedditEvent</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/queue_overlay.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/** @module queueOverlay */
function queueOverlay () {
    const self = new TB.Module('Queue Overlay');
    self.shortname = 'queueOverlay';

    // Default settings
    self.settings['enabled']['default'] = true;

    self.config['betamode'] = false;

    self.register_setting('overlayFromBarRedesign', {
        type: 'boolean',
        default: true,
        title: 'In redesign when clicking queue and unmoderated icons open the old reddit variants in an overlay.',
    });

    self.register_setting('overlayFromBarOld', {
        type: 'boolean',
        default: false,
        oldReddit: true,
        title: 'Open queue and unmoderated in overlay when clicking on them from the modbar.',
    });

    TB.register_module(self);

    self.init = function () {
        const $body = $('body');

        const modSubredditsFMod = TB.storage.getSetting('Notifier', 'modSubredditsFMod', false),
              modSubreddits = TB.storage.getSetting('Notifier', 'modSubreddits', 'mod'),
              unmoderatedSubredditsFMod = TB.storage.getSetting('Notifier', 'unmoderatedSubredditsFMod', false),
              unmoderatedSubreddits = TB.storage.getSetting('Notifier', 'unmoderatedSubreddits', 'mod');

        const overlayFromBarRedesign = self.setting('overlayFromBarRedesign'),
              overlayFromBarOld = self.setting('overlayFromBarOld');

        // Array used to keep track of loading iframes so that when the overlay gets closed we can properly stop all long load animations.
        let activeLoading = [];

        // For reports, spam and edited we don't have any settings in toolbox.
        // We simply assume people want to see the same as modqueue as that is most used.
        const baseUrls = {
            modqueue: {
                fmod: modSubredditsFMod,
                subreddits: modSubreddits,
            },
            unmoderated: {
                fmod: unmoderatedSubredditsFMod,
                subreddits: unmoderatedSubreddits,
            },
            reports: {
                fmod: modSubredditsFMod,
                subreddits: modSubreddits,
            },
            spam: {
                fmod: modSubredditsFMod,
                subreddits: modSubreddits,
            },
            edited: {
                fmod: modSubredditsFMod,
                subreddits: modSubreddits,
            },
        };

        if (TBCore.isModpage &amp;&amp; TBCore.isEmbedded) {
            $('head link[href*="//www.redditstatic.com/embedded."]').remove();
            $body.addClass('tb-embedded-queues');
            $body.find('.drop-choices a.choice').attr('target', '_self');
        }

        /**
         * Figures out what listing path to use and adds the multireddit representation to the input field on the respective tab.
         * @function figureOutMulti
         * @param {jqueryObject} $tbQueueUrl input element which will hold the multireddit representation
         * @param {string} type the listing type
         * @returns {string} the listing path to be used in overlays
         */
        function figureOutMulti ($tbQueueUrl, type, subreddit) {
            let listUrl;
            if (subreddit) {
                listUrl = `/r/${subreddit}/about/${type}`;
                $tbQueueUrl.val(subreddit);
            } else if (baseUrls[type].fmod) {
                listUrl = `/me/f/mod/about/${type}/`;
                $tbQueueUrl.val('mod');
            } else {
                listUrl = `/r/${baseUrls[type].subreddits}/about/${type}/`;
                $tbQueueUrl.val(baseUrls[type].subreddits);
            }

            return listUrl;
        }

        /**
         * Reload the iframe belonging to a queue listing based on latest data.
         * @function reloadIframe
         * @param {jqueryObject} $reloadListing reload button on the listing tab.
         * @param {jqueryObject} $tbQueueUrl input element which will hold the multireddit representation
         * @param {jqueryObject} $iframe iframe element to be reloaded
         * @param {string} type listing type
         */
        function reloadIframe ($reloadListing, $tbQueueUrl, $iframe, type) {
            $reloadListing.addClass('loading');
            TBui.longLoadSpinner(true);
            const multi = TBStorage.purify($tbQueueUrl.val());
            let newUrl;
            if (multi === 'mod' &amp;&amp; baseUrls[type].fmod) {
                newUrl = `/me/f/mod/about/${type}/`;
            } else {
                newUrl = `/r/${multi}/about/${type}/`;
            }
            $iframe.attr('src', `${TBCore.link(newUrl)}?embedded=true`);
        }

        /**
         * Creates the queue overlay or adds data to it if it is already open.
         * @function makeQueueOverlay
         * @param {string} type listing type
         * @param {object} options
         * @param {string} options.subreddit optional, when not given the user's toolbox settings for the listing will be used.
         * @param {boolean} options.overwrite when true will set the base over the overlay to the given subreddit and will reload the tab with this data.
         */
        function makeQueueOverlay (type, {subreddit, overwrite}) {
            let $overlay = $body.find('.tb-queue-overlay');

            // There is no open overlay so we'll create a new one.
            if (!$overlay.length) {
                $overlay = TB.ui.overlay(
                    'Toolbox queues',
                    [
                        {
                            title: 'modqueue',
                            tooltip: 'Moderation queue.',
                            content: `
                                &lt;div class="tb-queue-options">
                                    &lt;input type="text" class="tb-input tb-queue-url">
                                    &lt;span class="tb-icons tb-queue-reload">${TBui.icons.refresh}&lt;/span>
                                &lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'unmoderated',
                            tooltip: 'Unmoderated posts.',
                            content: `
                                &lt;div class="tb-queue-options">
                                    &lt;input type="text" class="tb-input tb-queue-url">
                                    &lt;span class="tb-icons tb-queue-reload">${TBui.icons.refresh}&lt;/span>
                                &lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'reports',
                            tooltip: 'reports.',
                            content: `
                                &lt;div class="tb-queue-options">
                                    &lt;input type="text" class="tb-input tb-queue-url">
                                    &lt;span class="tb-icons tb-queue-reload">${TBui.icons.refresh}&lt;/span>
                                &lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'spam',
                            tooltip: 'spam.',
                            content: `
                                &lt;div class="tb-queue-options">
                                    &lt;input type="text" class="tb-input tb-queue-url">
                                    &lt;span class="tb-icons tb-queue-reload">${TBui.icons.refresh}&lt;/span>
                                &lt;/div>
                            `,
                            footer: '',
                        },
                        {
                            title: 'edited',
                            tooltip: 'edited.',
                            content: `
                                &lt;div class="tb-queue-options">
                                    &lt;input type="text" class="tb-input tb-queue-url">
                                    &lt;span class="tb-icons tb-queue-reload">${TBui.icons.refresh}&lt;/span>
                                &lt;/div>
                            `,
                            footer: '',
                        },
                    ],
                    [], // extra header buttons
                    'tb-queue-overlay tb-overlay-horizontal-tabs', // class
                    false, // single overriding footer
                    {
                        subreddit,
                    },
                ).appendTo('body');

                $body.css('overflow', 'hidden');

                // Handle overlay closing.
                $body.on('click', '.tb-queue-overlay .tb-window-header .close', () => {
                    activeLoading.forEach(() => {
                        TBui.longLoadSpinner(false);
                    });
                    activeLoading = [];
                    $('.tb-queue-overlay').remove();
                    $body.css('overflow', 'auto');
                });
            }

            // Overwrite is given from triggers outside of the overlay and overwrites the "base" queue.
            if (overwrite) {
                $overlay.attr('data-subreddit', subreddit);
            }

            // There is already an active tab but overwritten is given. In this case we reload the tabs contents with the overwrite data.
            if (overwrite &amp;&amp; $overlay.find(`.tb-window-tab.${type} iframe.tb-queue-iframe`).length) {
                const $tabContent = $overlay.find(`.tb-window-tab.${type} .tb-window-content`);
                const $tbQueueUrl = $tabContent.find('.tb-queue-url');
                const $reloadListing = $tabContent.find('.tb-queue-reload');
                const $iframe = $tabContent.find('iframe.tb-queue-iframe');
                const listUrl = figureOutMulti($tbQueueUrl, type, subreddit);

                $reloadListing.addClass('loading');
                TBui.longLoadSpinner(true);

                $iframe.attr('src', `${TBCore.link(listUrl)}?embedded=true`);
            }

            // No listing is open in the tab yet. Create needed elements and load iframe.
            if (!$overlay.find(`.tb-window-tab.${type} iframe.tb-queue-iframe`).length) {
                TB.ui.longLoadSpinner(true);
                activeLoading.push('active');
                const $tabContent = $overlay.find(`.tb-window-tab.${type} .tb-window-content`);
                const $tbQueueUrl = $tabContent.find('.tb-queue-url');
                const $reloadListing = $tabContent.find('.tb-queue-reload');
                const listUrl = figureOutMulti($tbQueueUrl, type, subreddit);

                const $iframe = $(`&lt;iframe src="${TBCore.link(listUrl)}?embedded=true" class="tb-queue-iframe">&lt;/iframe>`).appendTo($tabContent);

                // Handle reloading from the reload button.
                $reloadListing.on('click', () => {
                    if (!$reloadListing.hasClass('loading')) {
                        reloadIframe($reloadListing, $tbQueueUrl, $iframe, type);
                    }
                });

                // Handle reloading when enter is hit in the multi input field.
                $tbQueueUrl.on('keyup', event => {
                    if (event.keyCode === 13 &amp;&amp; !$reloadListing.hasClass('loading')) {
                        reloadIframe($reloadListing, $tbQueueUrl, $iframe, type);
                    }
                });

                // Loading is done, remove loading indicators.
                $iframe.on('load', () => {
                    TBui.longLoadSpinner(false);
                    activeLoading.pop();
                    $reloadListing.removeClass('loading');
                });
            }

            // Switch to tab
            TBui.switchOverlayTab('tb-queue-overlay', type);
        }

        // A tab button is clicked, get details ready and load listing.
        $body.on('click', '.tb-queue-overlay .tb-window-tabs a', function () {
            const $this = $(this);
            const type = $this.attr('data-module');
            const subreddit = $this.closest('.tb-queue-overlay').attr('data-subreddit');
            makeQueueOverlay(type, {subreddit});
        });

        // eslint-disable-next-line no-extra-parens
        if ((TBCore.isOldReddit &amp;&amp; overlayFromBarOld) || (!TBCore.isOldReddit &amp;&amp; overlayFromBarRedesign &amp;&amp; !TBCore.isNewModmail)) {
            $body.on('click', '#tb-modqueue, #tb-queueCount', event => {
                if (event.ctrlKey || event.metaKey) {
                    return;
                }
                event.preventDefault();
                makeQueueOverlay('modqueue', {
                    overwrite: true,
                });
            });

            $body.on('click', '#tb-unmoderated, #tb-unmoderatedCount', event => {
                if (event.ctrlKey || event.metaKey) {
                    return;
                }
                event.preventDefault();
                makeQueueOverlay('unmoderated', {
                    overwrite: true,
                });
            });

            $body.on('click', '.tb-my-subreddits-subreddit a[data-type="unmoderated"], .tb-my-subreddits-subreddit a[data-type="modqueue"]', event => {
                if (event.ctrlKey || event.metaKey) {
                    return;
                }
                event.preventDefault();
                const $this = $(event.target);
                makeQueueOverlay($this.attr('data-type'), {
                    subreddit: $this.attr('data-subreddit'),
                    overwrite: true,
                });
            });
        }
    };
}

window.addEventListener('TBModuleLoaded', () => {
    queueOverlay();
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Thu Oct 31 2019 14:09:15 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
